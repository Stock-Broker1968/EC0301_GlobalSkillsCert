<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoría de Cumplimiento - EC0301</title>

    <script src="sistema_central/auth.js" defer></script>
    <script src="sistema_central/ec0301-data-manager.js" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof auth !== 'undefined' && !auth.isLoggedIn()) {
                window.location.replace('index.html');
            }
        });
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #1E3A8A; --accent: #FF6B35; --success: #22C55E; --warning: #F59E0B;
            --danger: #EF4444; --light: #F8FAFC; --border: #E5E7EB; --text: #1F2937; --muted: #6B7280;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #F1F5F9; color: var(--text); line-height: 1.7;
        }
        .header {
            background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--accent);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
        .header-content {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem; max-width: 1200px; margin: 0 auto;
        }
        h1 { font-size: 1.75rem; color: var(--primary); display: flex; align-items: center; gap: 0.75rem; }
        .btn {
            padding: 0.6rem 1.2rem; border: none; border-radius: 8px; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease; display: inline-flex;
            align-items: center; gap: 0.5rem; text-decoration: none;
        }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-ai:hover { background: linear-gradient(135deg, #5a6fde 0%, #684094 100%); }

        /* --- Estilos de Auditoría --- */
        .generation-panel {
            background: var(--white);
            color: var(--dark);
            border: 1px solid var(--border);
            padding: 2rem; border-radius: 16px; margin-bottom: 2rem;
            text-align: center;
        }
        .generation-panel h3 { margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; justify-content: center; }
        .generation-panel p { color: var(--muted); margin-bottom: 1.5rem; }
        
        .audit-results { display: none; } /* Oculto hasta ejecutar */

        .dictamen-box {
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 2rem;
        }
        .dictamen-box.aprobado {
            background: #F0FDF4;
            border: 2px solid var(--success);
        }
        .dictamen-box.no-cumple {
            background: #FFFBEB;
            border: 2px solid var(--danger);
        }
        .dictamen-box h2 {
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .dictamen-box.aprobado h2 { color: #166534; }
        .dictamen-box.no-cumple h2 { color: #B45309; }
        .dictamen-box p { color: var(--muted); }
        
        .progress-bar {
            width: 100%; background: var(--border); border-radius: 8px;
            height: 2.5rem; padding: 0.5rem; margin-bottom: 1rem;
        }
        .progress-fill {
            height: 100%; background: var(--success); border-radius: 4px;
            transition: width 0.5s ease-out;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 1.1rem;
        }

        .checklist-container {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.07);
        }
        .checklist-header {
            font-size: 1.25rem; font-weight: 700;
            padding: 1.5rem 2rem; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 0.75rem;
        }
        .checklist-body { padding: 2rem; }
        .checklist-item {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            padding: 1.25rem 0;
            border-bottom: 1px solid var(--border);
        }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item .icon { font-size: 1.5rem; }
        .checklist-item .icon .fa-check-circle { color: var(--success); }
        .checklist-item .icon .fa-times-circle { color: var(--danger); }
        .checklist-item .text strong {
            display: block;
            font-size: 1.1rem;
            color: var(--text);
        }
        .checklist-item .text span {
            font-size: 0.9rem;
            color: var(--muted);
        }
        
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--primary);
            border-top: 4px solid var(--light); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos para impresión */
        @media print {
            body { background: white; font-family: 'Georgia', 'Times New Roman', serif; }
            .header, .no-print { display: none !important; }
            .container { margin: 0; padding: 0; }
            .dictamen-box {
                background: var(--light) !important;
                border: 2px solid var(--border) !important;
            }
            .dictamen-box h2 { color: black !important; }
            .progress-bar { border: 2px solid var(--border); }
            .progress-fill { background: var(--muted) !important; }
            .checklist-item .icon .fa-check-circle { color: #333 !important; }
            .checklist-item .icon .fa-times-circle { color: #333 !important; }
            @page {
                size: letter;
                margin: 2cm;
            }
        }
    </style>
</head>
<body>
    <header class="header no-print">
        <div class="header-content">
            <h1><i class="fa-solid fa-shield-check" style="color: var(--accent);"></i> Auditoría de Cumplimiento</h1>
            <div>
                <a href="acceso.html" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
                <button class="btn btn-primary" onclick="printDocument()">
                    <i class="fa-solid fa-print"></i> Imprimir Auditoría
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="generation-panel">
            <h3><i class="fa-solid fa-robot"></i> Auditoría de Cumplimiento EC0301</h3>
            <p>Este módulo leerá todos tus productos (Carta Descriptiva, Evaluaciones, Manuales) y los validará contra los criterios del Estándar de Competencia EC0301.</p>
            <button class="btn btn-ai" onclick="runAudit()" id="audit-button">
                <i class="fa-solid fa-play"></i> Ejecutar Auditoría con IA
            </button>
        </div>

        <div id="loading-spinner" style="display: none; text-align: center; padding: 2rem;">
            <div class="spinner"></div>
            <p style="color: var(--muted); font-weight: 600;">Analizando portafolio de productos... Esto puede tardar un momento.</p>
        </div>

        <div class="audit-results" id="audit-results-container">
            <div class="dictamen-box" id="dictamen-box">
                <h2 id="dictamen-title"></h2>
                <p id="dictamen-subtitle"></p>
                <div class="progress-bar">
                    <div class="progress-fill" id="audit-progress-bar" style="width: 0%;">0%</div>
                </div>
                <p>A continuación se presenta el desglose de cumplimiento por producto.</p>
            </div>

            <div class="checklist-container">
                <div class="checklist-header">
                    <i class="fa-solid fa-list-check"></i> Reporte Detallado de Cumplimiento
                </div>
                <div class="checklist-body" id="checklist-body">
                    </div>
            </div>
        </div>

    </main>

    <script>
    let EC0301Manager;
    let cartaData = {};
    let evaluacionData = {};
    let manualesData = {};

    document.addEventListener('DOMContentLoaded', () => {
        // (AJUSTE) Verificar que los scripts globales estén cargados
        if (typeof auth === 'undefined' || typeof EC0301Manager === 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Error Crítico',
                text: 'No se pudieron cargar los módulos de sistema (auth.js, ec0301-data-manager.js). Revisa las rutas en el HTML.',
                confirmButtonColor: '#EF4444'
            }).then(() => window.location.href = 'index.html');
            return;
        }
        
        EC0301Manager = window.EC0301Manager;
    });

    /**
     * Muestra alerta si no se encuentran datos de la Carta Descriptiva
     */
    function showMissingDataAlert() {
        Swal.fire({
            icon: 'warning',
            title: 'Datos Incompletos',
            html: 'No se encontraron datos. Por favor, completa y <strong>guarda</strong> todos los módulos (Carta Descriptiva, Evaluaciones, Manuales) antes de ejecutar la auditoría.',
            confirmButtonText: 'Ir a Carta Descriptiva',
            confirmButtonColor: '#1E3A8A'
        }).then(() => {
            window.location.href = 'carta_descriptiva.html';
        });
    }

    /**
     * Punto de entrada para ejecutar la auditoría
     */
    async function runAudit() {
        try {
            // 1. Cargar todos los datos
            cartaData = EC0301Manager.getData();
            evaluacionData = EC0301Manager.loadProduct('evaluacion-sumativa') || [];
            manualesData = EC0301Manager.loadProduct('manuales') || {};
            
            if (!cartaData || !cartaData.nombre) {
                showMissingDataAlert();
                return;
            }
        } catch (error) {
            showMissingDataAlert();
            return;
        }

        // 2. Mostrar Spinner
        $('audit-button').disabled = true;
        $('loading-spinner').style.display = 'block';
        $('audit-results-container').style.display = 'none';

        // 3. Simular procesamiento de IA
        await new Promise(resolve => setTimeout(resolve, 3000));

        // 4. Ejecutar la lógica de auditoría
        const auditResults = runECAudit();
        
        // 5. Ocultar Spinner
        $('loading-spinner').style.display = 'none';
        $('audit-results-container').style.display = 'block';

        // 6. Mostrar resultados
        renderAuditResults(auditResults);
    }
    
    /**
     * El motor de auditoría "Inteligente"
     * Compara los datos guardados contra los criterios del EC0301
     */
    function runECAudit() {
        let checklist = [];
        let totalCriteria = 0;
        let passedCriteria = 0;

        // Función helper para validar y contar
        const check = (condition, passMsg, failMsg) => {
            totalCriteria++;
            let isPass = !!condition; // Checa si es truthy (no vacío, no nulo, no cero)
            if (isPass) {
                passedCriteria++;
                checklist.push({ pass: true, message: passMsg });
            } else {
                checklist.push({ pass: false, message: failMsg });
            }
        };

        // --- ELEMENTO 1: CARTA DESCRIPTIVA ---
        check(true, "Elemento 1: Diseñar cursos...", "Elemento 1: Diseñar cursos..."); // Título de sección
        check(cartaData.nombre, "Nombre del curso: Definido.", "Nombre del curso: No definido.");
        check(cartaData.diseñador, "Nombre del diseñador: Definido.", "Nombre del diseñador: No definido.");
        check(cartaData.psico, "Perfil del participante: Describe requisitos de ingreso (psicográficos).", "Perfil del participante: Faltan requisitos de ingreso (psicográficos).");
        check(cartaData.num, "Perfil del participante: Indica número de participantes.", "Perfil del participante: No indica número de participantes.");
        check(cartaData.og?.accion, "Objetivo General: Contiene Acción/Comportamiento.", "Objetivo General: Falta la Acción/Comportamiento.");
        check(cartaData.og?.cond, "Objetivo General: Contiene Condición de Operación.", "Objetivo General: Falta la Condición de Operación.");
        check(cartaData.og?.criterio, "Objetivo General: Contiene Criterio de Evaluación.", "Objetivo General: Falta el Criterio de Evaluación.");
        check(cartaData.objetivos?.length > 0, "Objetivos Particulares: Existen objetivos particulares.", "Objetivos Particulares: No se han definido.");
        check(cartaData.temas?.length > 0, "Contenido: Existen temas definidos.", "Contenido: No se ha definido el temario.");
        check(cartaData.dc?.integracion, "Momentos de Capacitación: Se define el Encuadre (integración).", "Momentos de Capacitación: Falta definir el Encuadre.");
        check(cartaData.dc?.cierre, "Momentos de Capacitación: Se define el Cierre.", "Momentos de Capacitación: Falta definir el Cierre.");
        check(cartaData.temas?.every(t => t.actividades), "Técnicas/Actividades: Todas los temas tienen actividades.", "Técnicas/Actividades: Faltan actividades en uno o más temas.");
        check(cartaData.ev?.diag?.ins && cartaData.ev?.form?.ins && cartaData.ev?.sum?.ins, "Estrategias de Evaluación: Se definen las 3 evaluaciones (Diag, Form, Sum).", "Estrategias de Evaluación: Falta definir una o más evaluaciones (Diag, Form, Sum).");
        check(cartaData.rq?.recursos, "Materiales Didácticos: Se especifican los recursos didácticos.", "Materiales Didácticos: No se especifican los recursos didácticos.");
        check(cartaData.dc?.encuadre_t && cartaData.dc?.cierre_t, "Tiempos: Se especifican tiempos para Encuadre y Cierre.", "Tiempos: Faltan tiempos de Encuadre o Cierre.");

        // --- ELEMENTO 2: INSTRUMENTOS DE EVALUACIÓN ---
        check(true, "Elemento 2: Diseñar instrumentos...", "Elemento 2: Diseñar instrumentos..."); // Título
        check(evaluacionData.length > 0, "Instrumento Sumativo: Se generó el banco de reactivos.", "Instrumento Sumativo: No se ha generado el banco de reactivos.");
        check(evaluacionData.every(p => p.pregunta && p.opciones?.length > 1), "Reactivos: Todos los reactivos tienen pregunta y opciones.", "Reactivos: Uno o más reactivos están incompletos.");
        check(EC0301Manager.loadProduct('respuestas'), "Clave de Respuestas: Se ha generado la Hoja de Respuestas.", "Clave de Respuestas: No se ha generado la Hoja de Respuestas.");
        check(cartaData.ev?.satisfaccion?.instrumento, "Instrumento de Satisfacción: Definido en la Carta Descriptiva.", "Instrumento de Satisfacción: No se ha definido (Revisar Sección 5 de Carta Descriptiva).");

        // --- ELEMENTO 3: MANUALES ---
        check(true, "Elemento 3: Diseñar manuales...", "Elemento 3: Diseñar manuales..."); // Título
        check(manualesData.participante, "Manual del Participante: El manual ha sido generado.", "Manual del Participante: No se ha generado.");
        check(manualesData.instructor, "Manual del Instructor: El manual ha sido generado.", "Manual del Instructor: No se ha generado.");
        check(manualesData.participante?.cover?.title, "Manual Participante: Incluye Portada.", "Manual Participante: Falta Portada.");
        check(manualesData.participante?.sections.find(s => s.id === 'introduccion'), "Manual Participante: Incluye Introducción.", "Manual Participante: Falta Introducción.");
        check(manualesData.participante?.sections.find(s => s.id === 'objetivo'), "Manual Participante: Incluye Objetivo General.", "Manual Participante: Falta Objetivo General.");
        check(manualesData.participante?.sections.find(s => s.id === 'evaluacion'), "Manual Participante: Incluye Sistema de Evaluación.", "Manual Participante: Falta Sistema de Evaluación.");
        check(manualesData.instructor?.cover?.title, "Manual Instructor: Incluye Portada.", "Manual Instructor: Falta Portada.");
        check(manualesData.instructor?.sections.find(s => s.id === 'cronograma_instructor'), "Manual Instructor: Incluye Carta Descriptiva/Cronograma.", "Manual Instructor: Falta Carta Descriptiva/Cronograma.");
        check(manualesData.instructor?.sections.find(s => s.id === 'evaluacion_instructor'), "Manual Instructor: Incluye Guía de Evaluación (Instrumentos).", "Manual Instructor: Falta Guía de Evaluación (Instrumentos).");

        // --- HÁBITOS/VALORES ---
        check(true, "Actitudes/Hábitos/Valores...", "Actitudes/Hábitos/Valores..."); // Título
        check(cartaData.objetivos?.every(o => o.accion && o.cond), "Orden: Todos los objetivos particulares están estructurados.", "Orden: Falta estructurar uno o más objetivos particulares.");

        const percentage = Math.round((passedCriteria / totalCriteria) * 100);
        return { checklist, percentage };
    }

    /**
     * Dibuja los resultados de la auditoría en el DOM
     */
    function renderAuditResults({ checklist, percentage }) {
        // 1. Dictamen y Barra de Progreso
        const dictamenBox = $('dictamen-box');
        const dictamenTitle = $('dictamen-title');
        const dictamenSubtitle = $('dictamen-subtitle');
        const progressBar = $('audit-progress-bar');
        
        progressBar.style.width = `${percentage}%`;
        progressBar.textContent = `${percentage}%`;
        
        if (percentage === 100) {
            dictamenBox.className = 'dictamen-box aprobado';
            dictamenTitle.innerHTML = '<i class="fa-solid fa-check-circle"></i> APROBADO';
            dictamenSubtitle.textContent = '¡Felicidades! Tu portafolio de productos cumple con todos los criterios del EC0301.';
            progressBar.style.backgroundColor = 'var(--success)';
        } else {
            dictamenBox.className = 'dictamen-box no-cumple';
            dictamenTitle.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> NO CUMPLE';
            dictamenSubtitle.textContent = `Tu portafolio tiene un ${percentage}% de cumplimiento. Revisa los puntos faltantes a continuación.`;
            progressBar.style.backgroundColor = (percentage > 50 ? 'var(--warning)' : 'var(--danger)');
        }

        // 2. Checklist Detallado
        const checklistBody = $('checklist-body');
        checklistBody.innerHTML = ''; // Limpiar resultados anteriores
        
        checklist.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'checklist-item';
            
            if (item.pass && item.message.startsWith('Elemento')) {
                // Es un título de sección, no un ítem
                itemEl.innerHTML = `<h4 style="color: var(--primary); margin-top: 1.5rem;">${item.message}</h4>`;
            } else {
                const icon = item.pass 
                    ? '<i class="fa-solid fa-check-circle"></i>' 
                    : '<i class="fa-solid fa-times-circle"></i>';
                const message = item.pass 
                    ? `<strong>${item.message.split(': ')[0]}</strong> <span>${item.message.split(': ')[1]}</span>`
                    : `<strong>${item.message.split(': ')[0]}</strong> <span style="color: var(--danger); font-weight: 600;">${item.message.split(': ')[1]}</span>`;
                
                itemEl.innerHTML = `
                    <div class="icon">${icon}</div>
                    <div class="text">${message}</div>
                `;
            }
            checklistBody.appendChild(itemEl);
        });
    }
    
    // ========== UTILIDADES ==========
    const $ = id => document.getElementById(id);

    function printDocument() {
        window.print();
    }
    </script>
</body>
</html>
