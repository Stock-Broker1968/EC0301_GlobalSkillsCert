<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta Descriptiva EC0301 - SkillsCert Professional</title>

    <script src="sistema_central/auth.js" defer></script>
    <script src="sistema_central/ec0301-data-manager.js" defer></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* (Tu CSS de 600+ l√≠neas va aqu√≠) */
        :root { 
            --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #818cf8;
            --accent: #FF6B35; --success: #10b981; --warning: #F59E0B;
            --danger: #ef4444; --dark: #1e293b; --light: #f1f5f9;
            --white: #ffffff; --border: #e2e8f0; --shadow: 0 10px 30px rgba(99, 102, 241, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: var(--dark); line-height: 1.6; }
        .header { background: var(--white); box-shadow: 0 2px 20px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--primary); }
        .header-content { max-width: 1400px; margin: 0 auto; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header-title { display: flex; align-items: center; gap: 1rem; }
        .header-title i { font-size: 2rem; color: var(--primary); }
        .header-title h1 { font-size: 1.5rem; color: var(--dark); font-weight: 700; }
        .header-title .subtitle { font-size: 0.85rem; color: #64748b; font-weight: 400; }
        .toolbar { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.65rem 1.25rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; text-decoration: none; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background: #64748b; color: var(--white); }
        .btn-secondary:hover { background: #475569; }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--warning); color: var(--white); }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-danger:hover { background: #dc2626; }
        .progress-container { background: var(--light); height: 8px; position: relative; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); transition: width 0.5s ease; border-radius: 0 4px 4px 0; box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem 2rem; }
        .section { background: var(--white); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border); animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { color: var(--primary); font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 3px solid var(--primary); display: flex; align-items: center; gap: 0.75rem; }
        .section-title i { font-size: 1.75rem; }
        .box { background: var(--light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border); position: relative; }
        .box h3 { color: var(--dark); margin-bottom: 1.25rem; font-size: 1.25rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .box h3 i { color: var(--primary); }
        .form-group { margin-bottom: 1.25rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--dark); font-size: 0.95rem; }
        label .required { color: var(--danger); margin-left: 0.25rem; }
        input, select, textarea { width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: all 0.3s; background: var(--white); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        textarea { min-height: 100px; resize: vertical; }
        input:disabled, select:disabled, textarea:disabled { background: var(--light); cursor: not-allowed; opacity: 0.7; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.25rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; }
        .doms { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .dom { padding: 0.75rem 1.25rem; background: var(--white); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 600; font-size: 0.9rem; }
        .dom:hover { border-color: var(--primary); transform: translateY(-2px); }
        .dom.active { background: var(--primary); color: var(--white); border-color: var(--primary); }
        .verbos-container { background: var(--white); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--border); }
        .verbos-container small { display: block; color: #64748b; margin-bottom: 0.75rem; font-weight: 600; }
        .verbo-category { margin: 0.75rem 0; }
        .verbo-category strong { display: block; color: var(--primary); font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .verbo { display: inline-block; padding: 0.4rem 0.9rem; margin: 0.25rem; background: var(--light); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; }
        .verbo:hover { background: var(--primary); color: var(--white); border-color: var(--primary); transform: scale(1.05); }
        .preview-box { background: linear-gradient(135deg, #e0e7ff 0%, #fef3c7 100%); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--primary); margin-top: 1rem; }
        .preview-box strong { display: block; color: var(--primary); margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .preview-box #og_preview { color: var(--dark); font-size: 1.05rem; line-height: 1.6; font-style: italic; }
        .time { background: var(--primary); color: var(--white); padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.5px; }
        .validation-indicator { position: fixed; bottom: 2rem; right: 2rem; background: var(--white); padding: 1.25rem 1.75rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 1rem; font-weight: 600; z-index: 999; transition: all 0.3s; border: 2px solid transparent; }
        .validation-indicator.valid { border-color: var(--success); animation: pulse-success 2s infinite; }
        .validation-indicator.invalid { border-color: var(--danger); }
        @keyframes pulse-success { 0%, 100% { box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3); } 50% { box-shadow: 0 10px 40px rgba(16, 185, 129, 0.6); } }
        .validation-indicator i { font-size: 1.5rem; }
        .help-tip { display: inline-block; background: var(--warning); color: var(--white); width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-size: 0.85rem; cursor: help; margin-left: 0.5rem; font-weight: 700; }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: stretch; }
            .toolbar { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .doms { flex-direction: column; }
            .dom { text-align: center; }
            .validation-indicator { bottom: 1rem; right: 1rem; left: 1rem; padding: 1rem; }
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .mt-1 { margin-top: 1rem; }
        .pulse { animation: pulse-btn 2s infinite; }
        @keyframes pulse-btn { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <i class="fas fa-file-contract"></i>
                <div>
                    <h1>Carta Descriptiva EC0301</h1>
                    <span class="subtitle">Guion Instruccional para Cursos en L√≠nea</span>
                </div>
            </div>
            <div class="toolbar">
                <a href="acceso.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Dashboard
                </a>
                <button class="btn btn-secondary" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i>
                    Ayuda
                </button>
                <button class="btn btn-primary" onclick="saveDraft()">
                    <i class="fas fa-save"></i>
                    Guardar
                </button>
                <button class="btn btn-success" onclick="validateForm()">
                    <i class="fas fa-check-circle"></i>
                    Validar
                </button>
                <button class="btn btn-warning" onclick="exportCarta('pdf')">
                    <i class="fas fa-file-pdf"></i>
                    Exportar PDF
                </button>
                <button class="btn btn-success pulse" onclick="markComplete()">
                    <i class="fas fa-trophy"></i>
                    Completar
                </button>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
    </header>

    <main class="container">
        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-info-circle"></i>
                1. Informaci√≥n General del Curso
            </h2>
            <div class="grid-2">
                <div class="form-group">
                    <label for="cd_nombre">Nombre del Curso/Taller <span class="required">*</span></label>
                    <input id="cd_nombre" placeholder="Ej: Dise√±o de cursos de capacitaci√≥n presencial" required>
                </div>
                <div class="form-group">
                    <label for="cd_duracion">Duraci√≥n total (horas) <span class="required">*</span></label>
                    <input id="cd_duracion" type="number" placeholder="Ej: 40" min="1" max="500" required>
                </div>
                <div class="form-group">
                    <label for="cd_dise√±ador">Nombre del dise√±ador instruccional <span class="required">*</span></label>
                    <input id="cd_dise√±ador" placeholder="Nombre completo del dise√±ador" required>
                </div>
                <div class="form-group">
                    <label for="cd_facilitador">Nombre del facilitador/tutor <span class="required">*</span></label>
                    <input id="cd_facilitador" placeholder="Nombre completo del facilitador" required>
                </div>
                <div class="form-group">
                    <label for="cd_modalidad">Modalidad del curso <span class="required">*</span></label>
                    <select id="cd_modalidad" required>
                        <option value="">Seleccione una opci√≥n...</option>
                        <option value="sincrono">En l√≠nea S√≠ncrono</option>
                        <option value="asincrono">En l√≠nea As√≠ncrono</option>
                        <option value="mixto">Mixto (S√≠ncrono y As√≠ncrono)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cd_proposito">Prop√≥sito/Beneficio del curso <span class="required">*</span></label>
                    <textarea id="cd_proposito" placeholder="Describa el prop√≥sito del curso y los beneficios que obtendr√° el participante y la organizaci√≥n..." required></textarea>
                </div>
            </div>
        </section>

        <section class="section">
             <h2 class="section-title">
                <i class="fas fa-users"></i>
                2. Perfil del Participante
            </h2>
            <div class="grid-2">
                <div class="form-group">
                    <label for="cd_psico">Caracter√≠sticas psicogr√°ficas <span class="required">*</span></label>
                    <textarea id="cd_psico" placeholder="Edad, ocupaci√≥n, nivel educativo, experiencia previa, motivaciones, estilo de aprendizaje..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="cd_conoc">Conocimientos previos requeridos <span class="required">*</span></label>
                    <textarea id="cd_conoc" placeholder="¬øQu√© debe saber el participante antes de iniciar el curso?" required></textarea>
                </div>
                <div class="form-group">
                    <label for="cd_hab">Habilidades tecnol√≥gicas requeridas <span class="required">*</span></label>
                    <textarea id="cd_hab" placeholder="Uso de navegador web, correo electr√≥nico, plataforma LMS, herramientas de videoconferencia..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="cd_actitudes">Actitudes deseables</label>
                    <textarea id="cd_actitudes" placeholder="Disposici√≥n al aprendizaje, trabajo colaborativo, autogesti√≥n del tiempo, proactividad..."></textarea>
                </div>
                <div class="form-group">
                    <label for="cd_num">N√∫mero de participantes <span class="required">*</span></label>
                    <input id="cd_num" placeholder="Ej: 15-25 personas" required>
                </div>
                <div class="form-group">
                    <label for="cd_tipo">Tipo de grupo <span class="required">*</span></label>
                    <select id="cd_tipo" required>
                        <option value="">Seleccione una opci√≥n...</option>
                        <option value="homogeneo">Homog√©neo (mismo perfil)</option>
                        <option value="heterogeneo">Heterog√©neo (perfiles diversos)</option>
                        <option value="mixto">Mixto</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-bullseye"></i>
                3. Objetivos de Aprendizaje
            </h2>

            <div class="box">
                <h3>
                    <span><i class="fas fa-star"></i> Objetivo General</span>
                    <span class="help-tip" title="Debe cumplir con criterios SMART: Espec√≠fico, Medible, Alcanzable, Relevante, Temporal">?</span>
                </h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Sujeto (predefinido)</label>
                        <input value="Al finalizar el curso, el participante" disabled>
                    </div>
                    <div class="form-group">
                        <label>Dominio principal <span class="required">*</span></label>
                        <select id="og_dom" required onchange="updateOG()">
                            <option value="">Seleccione el dominio...</option>
                            <option value="cognitivo">Cognitivo (Conocimientos)</option>
                            <option value="psicomotriz">Psicomotriz (Habilidades pr√°cticas)</option>
                            <option value="afectivo">Afectivo (Actitudes y valores)</option>
                            <option value="relacional">Relacional-Social</option>
                        </select>
                    </div>
                </div>
                <div class="form-group mt-1">
                    <label>Acci√≥n/Comportamiento observable <span class="required">*</span></label>
                    <textarea id="og_accion" placeholder="¬øQu√© ser√° capaz de hacer el participante al finalizar? Use verbos en futuro (dise√±ar√°, aplicar√°, evaluar√°...)" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="form-group mt-1">
                    <label>Condici√≥n de operaci√≥n <span class="required">*</span></label>
                    <textarea id="og_cond" placeholder="¬øEn qu√© contexto o bajo qu√© condiciones? (utilizando la plataforma LMS, a partir de casos pr√°cticos, con las herramientas proporcionadas...)" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="form-group mt-1">
                    <label>Criterio de evaluaci√≥n <span class="required">*</span></label>
                    <textarea id="og_criterio" placeholder="¬øC√≥mo se medir√° el logro? (cumpliendo con el 90% de la r√∫brica, sin errores, en tiempo establecido...)" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="preview-box">
                    <strong>Vista previa del objetivo:</strong>
                    <div id="og_preview">Complete los campos anteriores para visualizar el objetivo general...</div>
                </div>
            </div>

            <div id="objetivosParticulares">
                <div class="box" data-op="1">
                    <h3>
                        <span><i class="fas fa-tasks"></i> Objetivo Particular 1</span>
                    </h3>
                    <div class="doms">
                        <div class="dom active" data-op="1" data-d="cognitivo" onclick="selDom(1, 'cognitivo')">Cognitivo</div>
                        <div class="dom" data-op="1" data-d="psicomotriz" onclick="selDom(1, 'psicomotriz')">Psicomotriz</div>
                        <div class="dom" data-op="1" data-d="afectivo" onclick="selDom(1, 'afectivo')">Afectivo</div>
                        <div class="dom" data-op="1" data-d="relacional" onclick="selDom(1, 'relacional')">Relacional</div>
                    </div>
                    <div class="verbos-container" id="verbs1"></div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Verbo + Acci√≥n <span class="required">*</span></label>
                            <input id="op1_accion" placeholder="Ej: Identificar√° los elementos clave de..." required>
                        </div>
                        <div class="form-group">
                            <label>Condici√≥n/Contexto <span class="required">*</span></label>
                            <textarea id="op1_cond" placeholder="¬øEn qu√© condiciones o con qu√© recursos?" required></textarea>
                        </div>
                    </div>
                    <div class="form-group mt-1">
                        <label>Temas relacionados</label>
                        <textarea id="op1_temas" placeholder="Liste los temas o m√≥dulos que apoyan este objetivo (uno por l√≠nea)"></textarea>
                    </div>
                    <div class="form-group mt-1">
                        <label>Tiempo estimado (minutos)</label>
                        <input type="number" id="op1_tiempo" placeholder="120" min="15" onchange="recalcTimes()">
                    </div>
                </div>
            </div>
            <button class="btn btn-primary mt-1" onclick="addObjetivoParticular()">
                <i class="fas fa-plus"></i>
                Agregar Objetivo Particular
            </button>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-clipboard-list"></i>
                4. Requerimientos del Curso (EC0301)
            </h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Plataforma y Software <span class="required">*</span></label>
                    <textarea id="rq_plataforma" placeholder="LMS (Moodle, Canvas, Blackboard), herramientas de videoconferencia (Zoom, Teams), software especializado..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Recursos Did√°cticos Digitales <span class="required">*</span></label>
                    <textarea id="rq_recursos" placeholder="Manuales en PDF, videos, paquetes SCORM, infograf√≠as, simuladores, enlaces web, podcasts..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Materiales de Evaluaci√≥n <span class="required">*</span></label>
                    <textarea id="rq_evaluacion" placeholder="Cuestionarios en l√≠nea, r√∫bricas para foros, listas de cotejo para proyectos, ex√°menes automatizados..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Requerimientos de Hardware (participante)</label>
                    <textarea id="rq_hardware" placeholder="Computadora con acceso a internet, c√°mara web, micr√≥fono, auriculares..."></textarea>
                </div>
                <div class="form-group">
                    <label>Documentos Administrativos</label>
                    <textarea id="rq_admin" placeholder="Contrato de aprendizaje, carta de confidencialidad, lista de asistencia digital, encuesta de satisfacci√≥n..."></textarea>
                </div>
                <div class="form-group">
                    <label>Recursos Humanos de Soporte</label>
                    <textarea id="rq_rh" placeholder="Tutor/Facilitador, soporte t√©cnico, administrador de plataforma, coordinador acad√©mico..."></textarea>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i>
                5. Sistema de Evaluaci√≥n
            </h2>
            
            <div class="box">
                <h3>Criterios Generales</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Calificaci√≥n m√≠nima aprobatoria <span class="required">*</span></label>
                        <select id="ev_min" required onchange="recalcEval()">
                            <option value="">Seleccione...</option>
                            <option value="70">70%</option>
                            <option value="80" selected>80%</option>
                            <option value="85">85%</option>
                            <option value="90">90%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Escala de calificaci√≥n</label>
                        <select id="ev_escala">
                            <option value="0-100">0-100</option>
                            <option value="0-10">0-10</option>
                            <option value="NA-S">NA/S (No Acreditado/Suficiente)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de acreditaci√≥n</label>
                        <select id="ev_cert">
                            <option value="constancia">Constancia de participaci√≥n</option>
                            <option value="diploma">Diploma de acreditaci√≥n</option>
                            <option value="certificado">Certificado EC0301</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>Evaluaci√≥n Diagn√≥stica <span class="time">Inicio</span></h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Momento de aplicaci√≥n</label>
                        <input id="ev_diag_mom" placeholder="Ej: M√≥dulo 0 - Inicio del curso" value="M√≥dulo 0 - Inicio">
                    </div>
                    <div class="form-group">
                        <label>Instrumento</label>
                        <input id="ev_diag_ins" placeholder="Ej: Cuestionario en plataforma" value="Cuestionario en l√≠nea">
                    </div>
                    <div class="form-group">
                        <label>Prop√≥sito</label>
                        <input id="ev_diag_prop" placeholder="Ej: Identificar nivel inicial" value="Identificar conocimientos previos">
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>Evaluaci√≥n Formativa <span class="time">Durante</span></h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Ponderaci√≥n (%)</label>
                        <select id="ev_form_pct" onchange="recalcEval()">
                            <option value="30">30%</option>
                            <option value="40" selected>40%</option>
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Momentos de aplicaci√≥n</label>
                        <input id="ev_form_mom" placeholder="Ej: Al finalizar cada m√≥dulo" value="Al finalizar cada m√≥dulo/tema">
                    </div>
                    <div class="form-group">
                        <label>Instrumentos</label>
                        <input id="ev_form_ins" placeholder="Ej: Foros, tareas, wikis" value="Foros, entrega de tareas, cuestionarios">
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>Evaluaci√≥n Sumativa <span class="time">Final</span></h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Ponderaci√≥n (%) - Calculado autom√°ticamente</label>
                        <input id="ev_sum_pct" placeholder="60%" disabled>
                    </div>
                    <div class="form-group">
                        <label>Momento de aplicaci√≥n</label>
                        <input id="ev_sum_mom" placeholder="Ej: √öltimo m√≥dulo" value="M√≥dulo final del curso">
                    </div>
                    <div class="form-group">
                        <label>Instrumentos</label>
                        <input id="ev_sum_ins" placeholder="Ej: Examen final, proyecto" value="Examen final en l√≠nea, proyecto integrador">
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-clock"></i>
                6. Desarrollo Cronol√≥gico / Guion Instruccional
            </h2>

            <div class="box">
                <h3>Encuadre / M√≥dulo 0 <span class="time" id="encuadreTime">30 min</span></h3>
                <div class="form-group">
                    <label>Actividades de Encuadre (Inicio del curso)</label>
                    <textarea id="dc_integracion" placeholder="Bienvenida, presentaci√≥n de la plataforma, gu√≠a de navegaci√≥n, presentaci√≥n del tutor, foro social 'Cafeter√≠a', contrato de aprendizaje, evaluaci√≥n diagn√≥stica..."></textarea>
                </div>
                <div class="form-group mt-1">
                    <label>Tiempo estimado (minutos)</label>
                    <input type="number" id="dc_encuadre_t" value="30" min="5" onchange="recalcTimes()">
                </div>
            </div>

            <div class="box">
                <h3>Desarrollo de Contenidos <span class="time" id="desarrolloTime">0 min</span></h3>
                <div id="temasContainer"></div>
                <button class="btn btn-primary mt-1" onclick="addTema()">
                    <i class="fas fa-plus"></i>
                    Agregar Tema/M√≥dulo
                </button>
            </div>

            <div class="box">
                <h3>Cierre / M√≥dulo Final <span class="time" id="cierreTime">60 min</span></h3>
                <div class="form-group">
                    <label>Actividades de Cierre</label>
                    <textarea id="dc_cierre" placeholder="Resumen del curso, felicitaci√≥n, aplicaci√≥n de evaluaci√≥n sumativa, encuesta de satisfacci√≥n, siguientes pasos, descarga de constancias..."></textarea>
                </div>
                <div class="form-group mt-1">
                    <label>Tiempo estimado (minutos)</label>
                    <input type="number" id="dc_cierre_t" value="60" min="15" onchange="recalcTimes()">
                </div>
            </div>

            <div class="box">
                <h3>Distribuci√≥n del Tiempo Total</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Encuadre</label>
                        <input id="sum_encuadre" disabled>
                    </div>
                    <div class="form-group">
                        <label>Desarrollo</label>
                        <input id="sum_desarrollo" disabled>
                    </div>
                    <div class="form-group">
                        <label>Cierre</label>
                        <input id="sum_cierre" disabled>
                    </div>
                </div>
                <div class="form-group mt-1" style="text-align: right;">
                    <label>Total del Curso (calculado)</label>
                    <input id="sum_total" disabled style="font-weight: bold; color: var(--primary); max-width: 250px; display: inline-block;">
                </div>
            </div>
        </section>

    </main>

    <div class="validation-indicator invalid" id="validationIndicator" style="display: none;">
        <i class="fas fa-exclamation-circle" style="color: var(--danger);"></i>
        <span>Documento incompleto</span>
    </div>

    <script>
        // ========== CONSTANTES Y CONFIGURACI√ìN ==========
        const VERBOS = {
            cognitivo: {
                conocimiento: ['Identificar', 'Reconocer', 'Listar', 'Nombrar', 'Definir', 'Describir'],
                comprension: ['Explicar', 'Interpretar', 'Resumir', 'Clasificar', 'Comparar', 'Ejemplificar'],
                aplicacion: ['Aplicar', 'Usar', 'Implementar', 'Ejecutar', 'Resolver', 'Demostrar'],
                analisis: ['Analizar', 'Diferenciar', 'Organizar', 'Relacionar', 'Examinar', 'Contrastar'],
                evaluacion: ['Evaluar', 'Criticar', 'Justificar', 'Argumentar', 'Validar', 'Decidir'],
                creacion: ['Crear', 'Dise√±ar', 'Construir', 'Planear', 'Producir', 'Desarrollar']
            },
            psicomotriz: { 
                imitacion: ['Imitar', 'Copiar', 'Repetir', 'Reproducir', 'Seguir'],
                manipulacion: ['Manipular', 'Operar', 'Practicar', 'Ejecutar', 'Manejar'],
                precision: ['Demostrar', 'Completar', 'Mostrar', 'Calibrar', 'Controlar'],
                articulacion: ['Coordinar', 'Integrar', 'Adaptar', 'Modificar', 'Masterizar'],
                naturalizacion: ['Dise√±ar', 'Especificar', 'Gestionar', 'Inventar', 'Proyectar']
            },
            afectivo: {
                recepcion: ['Escuchar', 'Atender', 'Percibir', 'Recibir', 'Aceptar'],
                respuesta: ['Participar', 'Responder', 'Asistir', 'Practicar', 'Informar'],
                valoracion: ['Valorar', 'Apreciar', 'Justificar', 'Proponer', 'Compartir'],
                organizacion: ['Organizar', 'Integrar', 'Sintetizar', 'Priorizar', 'Combinar'],
                caracterizacion: ['Actuar', 'Discriminar', 'Influir', 'Modificar', 'Revisar']
            },
            relacional: { 
                interaccion: ['Interactuar', 'Comunicar', 'Relacionar', 'Contactar', 'Dialogar'],
                colaboracion: ['Colaborar', 'Cooperar', 'Contribuir', 'Ayudar', 'Apoyar'],
                liderazgo: ['Liderar', 'Dirigir', 'Guiar', 'Motivar', 'Inspirar'],
                negociacion: ['Negociar', 'Mediar', 'Conciliar', 'Acordar', 'Resolver'],
                facilitacion: ['Facilitar', 'Moderar', 'Coordinar', 'Dinamizar', 'Gestionar']
            }
        };

        // Variables globales
        const $ = id => document.getElementById(id);
        let objetivosCount = 1;
        let temasCount = 0;

        // ========== PROTECCI√ìN DE P√ÅGINA ==========
        
        // ===== CORRECCI√ìN 1: Mover la l√≥gica de protecci√≥n DENTRO de DOMContentLoaded =====
        // Esto asegura que auth.js y EC0301Manager.js hayan tenido tiempo de cargarse
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîç Verificando sistema...');
            
            // Verificar m√≥dulos
            if (typeof auth === 'undefined' || typeof EC0301Manager === 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error Cr√≠tico del Sistema',
                    html: '<p>No se pudieron cargar los m√≥dulos del sistema.</p><p>Verifica que existan:</p><ul style="text-align:left"><li>sistema_central/auth.js</li><li>sistema_central/ec0301-data-manager.js</li></ul>',
                    confirmButtonColor: '#ef4444',
                    allowOutsideClick: false
                }).then(() => window.location.href = 'index.html');
                return; // Detiene la ejecuci√≥n
            }

            // Verificar autenticaci√≥n
            if (!auth.isLoggedIn()) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Acceso Denegado',
                    text: 'Debes iniciar sesi√≥n para acceder a este m√≥dulo.',
                    confirmButtonColor: '#6366f1',
                    allowOutsideClick: false
                }).then(() => window.location.href = 'index.html');
                return; // Detiene la ejecuci√≥n
            }

            console.log('‚úÖ Sistema verificado correctamente');
            initializeApp();
        });

        // ========== INICIALIZACI√ìN ==========

        function initializeApp() {
            renderVerbos(1, 'cognitivo');
            loadDraft(); // Carga el borrador
            // Si no hay temas cargados, a√±ade uno por defecto
            if (temasCount === 0) {
                addTema();
            }
            recalcTimes();
            recalcEval();
            updateProgress();
            
            // Auto-guardar cada 30 segundos
            setInterval(() => {
                if (updateProgress() > 10) { // Solo si hay algo que guardar
                    saveDraft(true); // true = silencioso
                }
            }, 30000);
        }

        // ========== FUNCIONES DE VERBOS ==========
        // ... (El resto de tus funciones: renderVerbos, insertVerbo, selDom, updateOG, etc.) ...
        // ... (Tu c√≥digo para addObjetivoParticular, removeObjetivo, addTema, removeTema) ...
        // ... (Tu c√≥digo para recalcTimes, recalcEval, updateProgress, validateForm) ...

        // ========== GUARDAR Y CARGAR ==========

        function collectData() {
            const data = {
                // Informaci√≥n General
                nombre: $('cd_nombre').value,
                duracion: $('cd_duracion').value,
                dise√±ador: $('cd_dise√±ador').value,
                facilitador: $('cd_facilitador').value,
                modalidad: $('cd_modalidad').value,
                proposito: $('cd_proposito').value,
                // Perfil
                psico: $('cd_psico').value,
                conoc: $('cd_conoc').value,
                hab: $('cd_hab').value,
                actitudes: $('cd_actitudes').value,
                num: $('cd_num').value,
                tipo: $('cd_tipo').value,
                // Obj General
                og: {
                    dom: $('og_dom').value,
                    accion: $('og_accion').value,
                    cond: $('og_cond').value,
                    criterio: $('og_criterio').value
                },
                objetivos: [],
                // Requerimientos
                rq: {
                    plataforma: $('rq_plataforma').value,
                    recursos: $('rq_recursos').value,
                    evaluacion: $('rq_evaluacion').value,
                    hardware: $('rq_hardware').value,
                    admin: $('rq_admin').value,
                    rh: $('rq_rh').value
                },
                // Evaluaci√≥n
                ev: {
                    min: $('ev_min').value,
                    escala: $('ev_escala').value,
                    cert: $('ev_cert').value,
                    diag: { mom: $('ev_diag_mom').value, ins: $('ev_diag_ins').value, prop: $('ev_diag_prop').value },
                    form: { pct: $('ev_form_pct').value, mom: $('ev_form_mom').value, ins: $('ev_form_ins').value },
                    sum: { pct: $('ev_sum_pct').value, mom: $('ev_sum_mom').value, ins: $('ev_sum_ins').value }
                },
                // Desarrollo
                dc: {
                    integracion: $('dc_integracion').value,
                    encuadre_t: $('dc_encuadre_t').value,
                    cierre: $('dc_cierre').value,
                    cierre_t: $('dc_cierre_t').value
                },
                temas: [],
                fechaActualizacion: new Date().toISOString()
            };

            // Recopilar los objetivos particulares
            document.querySelectorAll('#objetivosParticulares .box').forEach(box => {
                const n = box.dataset.op;
                if ($(`op${n}_accion`)) {
                    data.objetivos.push({
                        num: n,
                        dom: document.querySelector(`[data-op="${n}"] .dom.active`)?.dataset.d || 'cognitivo',
                        accion: $(`op${n}_accion`).value,
                        cond: $(`op${n}_cond`).value,
                        temas: $(`op${n}_temas`).value,
                        tiempo: $(`op${n}_tiempo`)?.value || ''
                    });
                }
            });
            
            // Recopilar los temas
            document.querySelectorAll('#temasContainer .box').forEach(box => {
                const n = box.dataset.tema;
                if ($(`tema${n}_nombre`)) {
                    data.temas.push({
                        num: n,
                        nombre: $(`tema${n}_nombre`).value,
                        duracion: $(`tema${n}_duracion`).value,
                        actividades: $(`tema${n}_actividades`).value,
                        recursos: $(`tema${n}_recursos`).value,
                        interaccion: $(`tema${n}_interaccion`).value,
                        evaluacion: $(`tema${n}_evaluacion`).value
                    });
                }
            });
            return data;
        }

        function saveDraft(silent = false) {
            if (!EC0301Manager) {
                if (!silent) toast('Error: M√≥dulo de datos no cargado', 'error');
                return;
            }
            try {
                const data = collectData();
                EC0301Manager.saveData(data); // Guarda todo el objeto de la carta
                if (!silent) toast('Borrador guardado', 'success');
                updateProgress();
            } catch (e) {
                if (!silent) toast(`Error al guardar: ${e.message}`, 'error');
            }
        }

        function loadDraft() {
            if (!EC0301Manager) {
                toast('Error: M√≥dulo de datos no cargado', 'error');
                return;
            }
            try {
                const data = EC0301Manager.getData();
                if (!data || !data.nombre) { 
                    toast('No hay datos guardados. Empezando un nuevo documento.', 'info');
                    addTema(); // A√±ade el primer tema si el documento est√° vac√≠o
                    return;
                }
                
                // Cargar informaci√≥n general
                $('cd_nombre').value = data.nombre || '';
                $('cd_duracion').value = data.duracion || '';
                $('cd_dise√±ador').value = data.dise√±ador || '';
                $('cd_facilitador').value = data.facilitador || '';
                $('cd_modalidad').value = data.modalidad || '';
                $('cd_proposito').value = data.proposito || '';
                // ... (Cargar el resto de los campos: psico, conoc, hab, etc.) ...
                $('cd_psico').value = data.psico || '';
                $('cd_conoc').value = data.conoc || '';
                $('cd_hab').value = data.hab || '';
                $('cd_actitudes').value = data.actitudes || '';
                $('cd_num').value = data.num || '';
                $('cd_tipo').value = data.tipo || '';
                
                if (data.og) {
                    $('og_dom').value = data.og.dom || '';
                    $('og_accion').value = data.og.accion || '';
                    $('og_cond').value = data.og.cond || '';
                    $('og_criterio').value = data.og.criterio || '';
                    updateOG();
                }
                
                if (data.rq) {
                    $('rq_plataforma').value = data.rq.plataforma || '';
                    $('rq_recursos').value = data.rq.recursos || '';
                    $('rq_evaluacion').value = data.rq.evaluacion || '';
                    $('rq_hardware').value = data.rq.hardware || '';
                    $('rq_admin').value = data.rq.admin || '';
                    $('rq_rh').value = data.rq.rh || '';
                }
                
                if (data.ev) {
                    $('ev_min').value = data.ev.min || '80';
                    $('ev_escala').value = data.ev.escala || '0-100';
                    $('ev_cert').value = data.ev.cert || 'constancia';
                    if (data.ev.diag) {
                        $('ev_diag_mom').value = data.ev.diag.mom || '';
                        $('ev_diag_ins').value = data.ev.diag.ins || '';
                        $('ev_diag_prop').value = data.ev.diag.prop || '';
                    }
                    if (data.ev.form) {
                        $('ev_form_pct').value = data.ev.form.pct || '40';
                        $('ev_form_mom').value = data.ev.form.mom || '';
                        $('ev_form_ins').value = data.ev.form.ins || '';
                    }
                    if (data.ev.sum) {
                        $('ev_sum_pct').value = data.ev.sum.pct || '60%';
                        $('ev_sum_mom').value = data.ev.sum.mom || '';
                        $('ev_sum_ins').value = data.ev.sum.ins || '';
                    }
                }
                
                if (data.dc) {
                    $('dc_integracion').value = data.dc.integracion || '';
                    $('dc_encuadre_t').value = data.dc.encuadre_t || '30';
                    $('dc_cierre').value = data.dc.cierre || '';
                    $('dc_cierre_t').value = data.dc.cierre_t || '60';
                }
                
                // Cargar Objetivos Particulares
                if (data.objetivos && data.objetivos.length > 0) {
                    $('objetivosParticulares').innerHTML = '';
                    objetivosCount = 0; 
                    data.objetivos.forEach(obj => {
                        objetivosCount++; // Asegura que el conteo sea 1, 2, 3...
                        const container = $('objetivosParticulares');
                        const newObj = document.createElement('div');
                        newObj.className = 'box';
                        newObj.setAttribute('data-op', objetivosCount);
                        newObj.innerHTML = `
                            <h3>
                                <span><i class="fas fa-tasks"></i> Objetivo Particular ${objetivosCount}</span>
                                <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="removeObjetivo(this, ${objetivosCount})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </h3>
                            <div class="doms">
                                <div class="dom ${obj.dom === 'cognitivo' ? 'active' : ''}" data-op="${objetivosCount}" data-d="cognitivo" onclick="selDom(${objetivosCount}, 'cognitivo')">Cognitivo</div>
                                <div class="dom ${obj.dom === 'psicomotriz' ? 'active' : ''}" data-op="${objetivosCount}" data-d="psicomotriz" onclick="selDom(${objetivosCount}, 'psicomotriz')">Psicomotriz</div>
                                <div class="dom ${obj.dom === 'afectivo' ? 'active' : ''}" data-op="${objetivosCount}" data-d="afectivo" onclick="selDom(${objetivosCount}, 'afectivo')">Afectivo</div>
                                <div class="dom ${obj.dom === 'relacional' ? 'active' : ''}" data-op="${objetivosCount}" data-d="relacional" onclick="selDom(${objetivosCount}, 'relacional')">Relacional</div>
                            </div>
                            <div class="verbos-container" id="verbs${objetivosCount}"></div>
                            <div class="grid-2">
                                <div class="form-group"><label>Verbo + Acci√≥n <span class="required">*</span></label><input id="op${objetivosCount}_accion" value="${obj.accion || ''}" required></div>
                                <div class="form-group"><label>Condici√≥n/Contexto <span class="required">*</span></label><textarea id="op${objetivosCount}_cond" required>${obj.cond || ''}</textarea></div>
                            </div>
                            <div class="form-group mt-1"><label>Temas relacionados</label><textarea id="op${objetivosCount}_temas">${obj.temas || ''}</textarea></div>
                            <div class="form-group mt-1"><label>Tiempo estimado (minutos)</label><input type="number" id="op${objetivosCount}_tiempo" value="${obj.tiempo || ''}" min="15" onchange="recalcTimes()"></div>
                        `;
                        container.appendChild(newObj);
                        renderVerbos(objetivosCount, obj.dom || 'cognitivo');
                    });
                }

                // Cargar Temas
                if (data.temas && data.temas.length > 0) {
                    $('temasContainer').innerHTML = '';
                    temasCount = 0; 
                    data.temas.forEach(tema => {
                        temasCount++; // Asegura que el conteo sea 1, 2, 3...
                        const container = $('temasContainer');
                        const temaEl = document.createElement('div');
                        temaEl.className = 'box';
                        temaEl.setAttribute('data-tema', temasCount);
                        temaEl.innerHTML = `
                            <h3>
                                <span>Tema/M√≥dulo ${temasCount}</span>
                                <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="removeTema(this, ${temasCount})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </h3>
                            <div class="grid-2">
                                <div class="form-group"><label>Nombre del Tema/M√≥dulo <span class="required">*</span></label><input id="tema${temasCount}_nombre" value="${tema.nombre || ''}" required></div>
                                <div class="form-group"><label>Duraci√≥n (minutos) <span class="required">*</span></label><input type="number" id="tema${temasCount}_duracion" value="${tema.duracion || ''}" min="15" onchange="recalcTimes()" required></div>
                            </div>
                            <div class="form-group mt-1"><label>Actividades de aprendizaje (en plataforma)</label><textarea id="tema${temasCount}_actividades">${tema.actividades || ''}</textarea></div>
                            <div class="grid-3 mt-1">
                                <div class="form-group"><label>Recursos Did√°cticos Digitales</label><input id="tema${temasCount}_recursos" value="${tema.recursos || ''}"></div>
                                <div class="form-group"><label>Interacci√≥n (Tutor-Participante)</label><select id="tema${temasCount}_interaccion"><option value="asincrona" ${tema.interaccion === 'asincrona' ? 'selected' : ''}>As√≠ncrona</option><option value="sincrona" ${tema.interaccion === 'sincrona' ? 'selected' : ''}>S√≠ncrona</option><option value="ninguna" ${tema.interaccion === 'ninguna' ? 'selected' : ''}>Ninguna</option></select></div>
                                <div class="form-group"><label>Instrumento de Evaluaci√≥n</label><input id="tema${temasCount}_evaluacion" value="${tema.evaluacion || ''}"></div>
                            </div>
                        `;
                        container.appendChild(temaEl);
                    });
                }
                
                recalcTimes();
                recalcEval
