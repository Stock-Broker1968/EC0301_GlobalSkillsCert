<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta Descriptiva EC0217.01 - SkillsCert Professional</title>

    <script src="sistema_central/auth.js" defer></script>
    <script src="sistema_central/ec0301-data-manager.js" defer></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --accent: #FF6B35;
            --success: #10b981;
            --warning: #F59E0B;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f1f5f9;
            --white: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 10px 30px rgba(99, 102, 241, 0.1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.6;
        }
        /* ========== HEADER ========== */
        .header {
            background: var(--white);
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--primary);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .header-title i {
            font-size: 2rem;
            color: var(--primary);
        }
        .header-title h1 {
            font-size: 1.5rem;
            color: var(--dark);
            font-weight: 700;
        }
        .header-title .subtitle {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 400;
        }
        .toolbar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .btn {
            padding: 0.65rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            text-decoration: none;
            white-space: nowrap;
        }
        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .btn-secondary {
            background: #64748b;
            color: var(--white);
        }
        .btn-secondary:hover {
            background: #475569;
        }
        .btn-success {
            background: var(--success);
            color: var(--white);
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }
        .btn-warning:hover {
            background: #d97706;
        }
        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        /* ========== PROGRESS BAR ========== */
        .progress-container {
            background: var(--light);
            height: 8px;
            position: relative;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            transition: width 0.5s ease;
            border-radius: 0 4px 4px 0;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        /* ========== MAIN CONTAINER ========== */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem 2rem;
        }
        /* ========== SECTIONS ========== */
        .section {
            background: var(--white);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .section-title {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .section-title i {
            font-size: 1.75rem;
        }
        /* ========== BOX COMPONENTS ========== */
        .box {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            position: relative;
        }
        .box h3 {
            color: var(--dark);
            margin-bottom: 1.25rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .box h3 i {
            color: var(--primary);
        }
        /* ========== FORM ELEMENTS ========== */
        .form-group {
            margin-bottom: 1.25rem;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-size: 0.95rem;
        }
        label .required {
            color: var(--danger);
            margin-left: 0.25rem;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.85rem; 
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s;
            background: var(--white);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        textarea {
            min-height: 130px; 
            resize: vertical;
        }
        input:disabled, select:disabled, textarea:disabled {
            background: var(--light);
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* ========== GRID LAYOUTS ========== */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.25rem;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
        }
        .grid-5-dev {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 1rem;
            align-items: start;
        }
        .time-input { max-width: 100px; text-align: right; }
        .total-time-box { background: var(--primary-light); border: 2px solid var(--primary); }
        .total-time-box #sum_total { font-size: 1.1rem; color: var(--primary-dark); }
        .total-time-box #time_warning { color: var(--danger); font-weight: 600; }
        
        /* ========== DOMAIN SELECTOR ========== */
        .doms {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .dom {
            padding: 0.75rem 1.25rem;
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .dom:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .dom.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }
        /* ========== VERBOS SELECTOR ========== */
        .verbos-container {
            background: var(--white);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid var(--border);
        }
        .verbos-container small {
            display: block;
            color: #64748b;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        .verbo-category {
            margin: 0.75rem 0;
        }
        .verbo-category strong {
            display: block;
            color: var(--primary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .verbo {
            display: inline-block;
            padding: 0.4rem 0.9rem;
            margin: 0.25rem;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .verbo:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        /* ========== PREVIEW BOX ========== */
        .preview-box {
            background: linear-gradient(135deg, #e0e7ff 0%, #fef3c7 100%);
            padding: 1.25rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            margin-top: 1rem;
        }
        .preview-box strong {
            display: block;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .preview-box #og_preview {
            color: var(--dark);
            font-size: 1.05rem;
            line-height: 1.6;
            font-style: italic;
        }
        /* ========== TIME BADGES ========== */
        .time {
            background: var(--primary);
            color: var(--white);
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        /* ========== VALIDATION INDICATOR ========== */
        .validation-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--white);
            padding: 1.25rem 1.75rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            z-index: 999;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .validation-indicator.valid {
            border-color: var(--success);
            animation: pulse-success 2s infinite;
        }
        .validation-indicator.invalid {
            border-color: var(--danger);
        }
        @keyframes pulse-success {
            0%, 100% {
                box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
            }
            50% {
                box-shadow: 0 10px 40px rgba(16, 185, 129, 0.6);
            }
        }
        .validation-indicator i {
            font-size: 1.5rem;
        }
        /* ========== HELP TIP ========== */
        .help-tip {
            display: inline-block;
            background: var(--warning);
            color: var(--white);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 0.85rem;
            cursor: help;
            margin-left: 0.5rem;
            font-weight: 700;
        }
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            .toolbar {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
            .grid-2, .grid-3, .grid-4, .grid-5-dev {
                grid-template-columns: 1fr;
            }
            .doms {
                flex-direction: column;
            }
            .dom {
                text-align: center;
            }
            .validation-indicator {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                padding: 1rem;
            }
        }
        /* ========== ANIMATIONS ========== */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .mt-1 {
            margin-top: 1rem;
        }
        .pulse {
            animation: pulse-btn 2s infinite;
        }
        @keyframes pulse-btn {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <i class="fas fa-file-contract"></i>
                <div>
                    <h1>Carta Descriptiva</h1>
                    <span class="subtitle">Guion Instruccional (Presencial / Mixto)</span>
                </div>
            </div>
            <div class="toolbar">
                <a href="acceso.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Dashboard
                </a>
                <button class="btn btn-secondary" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i>
                    Ayuda
                </button>
                <button class="btn btn-primary" onclick="saveDraft()">
                    <i class="fas fa-save"></i>
                    Guardar
                </button>
                <button class="btn btn-success" onclick="validateForm()">
                    <i class="fas fa-check-circle"></i>
                    Validar
                </button>
                <button class="btn btn-warning" onclick="exportCarta('pdf')">
                    <i class="fas fa-file-pdf"></i>
                    Exportar PDF
                </button>
                <button class="btn btn-success pulse" onclick="markComplete()">
                    <i class="fas fa-trophy"></i>
                    Completar
                </button>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
    </header>

    <main class="container">

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-info-circle"></i>
                1. Informaci√≥n General del Curso
            </h2>
            <div class="grid-3">
                <div class="form-group">
                    <label for="cd_nombre">Nombre del Curso/Taller <span class="required">*</span></label>
                    <input id="cd_nombre" placeholder="Ej: Curso de Inducci√≥n..." required>
                </div>
                <div class="form-group">
                    <label for="cd_duracion">Duraci√≥n total (horas) <span class="required">*</span></label>
                    <input id="cd_duracion" type="number" placeholder="Ej: 8" min="1" max="500" required onchange="recalcTimes()">
                </div>
                <div class="form-group">
                    <label for="cd_facilitador">Nombre del facilitador/instructor <span class="required">*</span></label>
                    <input id="cd_facilitador" placeholder="Nombre completo del facilitador" required>
                </div>
                
                <div class="form-group">
                    <label for="cd_lugar">Lugar de Instrucci√≥n</label>
                    <input id="cd_lugar" placeholder="Ej: Insurgentes Sur No. 700, CDMX">
                </div>
                <div class="form-group">
                    <label for="cd_fecha">Fecha(s) de impartici√≥n</label>
                    <input id="cd_fecha" type="text" placeholder="Ej: 14 agosto 2025">
                </div>
                
                <div class="form-group">
                    <label for="cd_modalidad">Modalidad del curso <span class="required">*</span></label>
                    <select id="cd_modalidad" required>
                        <option value="">Seleccione una opci√≥n...</option>
                        <option value="presencial" selected>Presencial (EC0217)</option>
                        <option value="mixto">Mixto (L√≠nea y Presencial)</option>
                        <option value="linea_sincrono">En l√≠nea S√≠ncrono (EC0301)</option>
                        <option value="linea_asincrono">En l√≠nea As√≠ncrono (EC0301)</option>
                    </select>
                </div>
            </div>
             <div class="form-group">
                <label for="cd_dise√±ador">Nombre del dise√±ador <span class="required">*</span></label>
                <input id="cd_dise√±ador" placeholder="Nombre completo del dise√±ador" required>
            </div>
            <div class="form-group mt-1">
                <label for="cd_proposito">Prop√≥sito/Beneficio del curso <span class="required">*</span></label>
                <textarea id="cd_proposito" placeholder="Describa el prop√≥sito del curso y los beneficios que obtendr√° el participante y la organizaci√≥n..." required></textarea>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-users"></i>
                2. Perfil del Participante
            </h2>
            <div class="grid-2">
                <div class="form-group">
                    <label for="cd_perfil">Perfil del Participante (Caracter√≠sticas) <span class="required">*</span></label>
                    <textarea id="cd_perfil" placeholder="Edad, ocupaci√≥n, nivel educativo, experiencia previa, motivaciones, estilo de aprendizaje..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="cd_conoc">Conocimientos previos requeridos <span class="required">*</span></label>
                    <textarea id="cd_conoc" placeholder="¬øQu√© debe saber el participante antes de iniciar el curso?" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="cd_hab">Habilidades requeridas (t√©cnicas/tecnol√≥gicas) <span class="required">*</span></label>
                    <textarea id="cd_hab" placeholder="Uso de equipo de c√≥mputo, software espec√≠fico, o herramientas manuales (si aplica)..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="cd_actitudes">Actitudes deseables</label>
                    <textarea id="cd_actitudes" placeholder="Disposici√≥n al aprendizaje, trabajo colaborativo, autogesti√≥n del tiempo, proactividad..."></textarea>
                </div>
                <div class="form-group">
                    <label for="cd_num">N√∫mero de participantes <span class="required">*</span></label>
                    <input id="cd_num" type="number" min="1" placeholder="Ej: 15" required>
                </div>
                <div class="form-group">
                    <label for="cd_tipo">Tipo de grupo <span class="required">*</span></label>
                    <select id="cd_tipo" required>
                        <option value="">Seleccione una opci√≥n...</option>
                        <option value="homogeneo">Homog√©neo (mismo perfil)</option>
                        <option value="heterogeneo">Heterog√©neo (perfiles diversos)</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-bullseye"></i>
                3. Objetivos de Aprendizaje
            </h2>

            <div class="box">
                <h3>
                    <span><i class="fas fa-star"></i> Objetivo General</span>
                    <span class="help-tip" title="Debe cumplir con criterios SMART: Espec√≠fico, Medible, Alcanzable, Relevante, Temporal">?</span>
                </h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Sujeto (predefinido)</label>
                        <input value="Al finalizar el curso, el participante" disabled>
                    </div>
                    <div class="form-group">
                        <label>Dominio principal <span class="required">*</span></label>
                        <select id="og_dom" required onchange="updateOG()">
                            <option value="">Seleccione el dominio...</option>
                            <option value="cognitivo">Cognitivo (Conocimientos)</option>
                            <option value="psicomotriz">Psicomotriz (Habilidades pr√°cticas)</option>
                            <option value="afectivo">Afectivo (Actitudes y valores)</option>
                            <option value="relacional">Relacional-Social</option>
                        </select>
                    </div>
                </div>
                <div class="form-group mt-1">
                    <label>Acci√≥n/Comportamiento observable <span class="required">*</span></label>
                    <textarea id="og_accion" placeholder="¬øQu√© ser√° capaz de hacer el participante al finalizar? Use verbos en futuro (dise√±ar√°, aplicar√°, evaluar√°...)" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="form-group mt-1">
                    <label>Condici√≥n de operaci√≥n <span class="required">*</span></label>
                    <textarea id="og_cond" placeholder="¬øEn qu√© contexto o bajo qu√© condiciones? (a partir de casos pr√°cticos, con las herramientas proporcionadas...)" required onkeyup="updateOG()"></textarea>
                </div>
                
                <input type="hidden" id="og_criterio" value="seg√∫n lo establecido en la secci√≥n de evaluaci√≥n">
                
                <div class="preview-box">
                    <strong>Vista previa del objetivo:</strong>
                    <div id="og_preview">Complete los campos anteriores para visualizar el objetivo general...</div>
                </div>
            </div>

            <div id="objetivosParticulares">
                </div>
            <button class="btn btn-primary mt-1" onclick="addObjetivoParticular()">
                <i class="fas fa-plus"></i>
                Agregar Objetivo Particular
            </button>
        </section>
        
        <section class="section">
             <h2 class="section-title">
                <i class="fas fa-clipboard-list"></i>
                4. Requerimientos del Curso (Para ser llenado por el usuario)
            </h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Requerimientos en instalaciones, mobiliario y su distribuci√≥n <span class="required">*</span></label>
                    <textarea id="rq_instalaciones" placeholder="1. Sal√≥n o aula para X personas...&#10;2. Mesas y sillas...&#10;3. Distribuci√≥n en 'U' o herradura...&#10;4. Acceso a sanitarios y rutas de evacuaci√≥n..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Requerimientos en equipo de apoyo y su distribuci√≥n <span class="required">*</span></label>
                    <textarea id="rq_equipo" placeholder="1. Laptop para el instructor&#10;2. Pantalla o proyector...&#10;3. Pizarr√≥n blanco o pintarr√≥n...&#10;4. Extensi√≥n el√©ctrica y multicontactos..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Material y equipo para medidas de salud/seguridad <span class="required">*</span></label>
                    <textarea id="rq_seguridad" placeholder="1. Gel antibacterial...&#10;2. Se√±alizaci√≥n de rutas de evacuaci√≥n...&#10;3. Botiqu√≠n de primeros auxilios..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Materiales de apoyo (did√°cticos) <span class="required">*</span></label>
                    <textarea id="rq_materiales" placeholder="1. Formatos de evaluaci√≥n (diagn√≥stica, formativa, sumativa)&#10;2. Contratos de aprendizaje...&#10;3. Manual del participante...&#10;4. Plumones, hojas, bol√≠grafos..." required></textarea>
                </div>
            </div>
            <div class="form-group mt-1">
                <label>Requerimientos humanos <span class="required">*</span></label>
                <textarea id="rq_humanos" placeholder="1. Instructor certificado en EC0217...&#10;2. Personal de apoyo log√≠stico (opcional)..." required></textarea>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i>
                5. Sistema de Evaluaci√≥n
            </h2>
            
            <div class="box">
                <h3>Criterios Generales</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Calificaci√≥n m√≠nima aprobatoria <span class="required">*</span></label>
                        <select id="ev_min" required>
                            <option value="">Seleccione...</option>
                            <option value="70">70%</option>
                            <option value="80" selected>80%</option>
                            <option value="85">85%</option>
                            <option value="90">90%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Escala de calificaci√≥n</label>
                        <select id="ev_escala">
                            <option value="0-100" selected>0-100</option>
                            <option value="0-10">0-10</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de acreditaci√≥n</label>
                        <select id="ev_cert">
                            <option value="constancia">Constancia de participaci√≥n</option>
                            <option value="diploma">Diploma de acreditaci√≥n</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>Evaluaci√≥n Diagn√≥stica <span class="time">Inicio</span></h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Porcentaje (%)</label>
                        <input type="number" id="ev_diag_pct" value="10" oninput="sumarPorcentajes()">
                    </div>
                    <div class="form-group">
                        <label>Instrumento</label>
                        <input id="ev_diag_ins" value="Cuestionario">
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <input id="ev_diag_tipo" value="Heteroevaluaci√≥n" placeholder="Heteroevaluaci√≥n, Coevaluaci√≥n...">
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>Evaluaci√≥n Formativa <span class="time">Durante</span></h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Porcentaje (%)</label>
                        <input type="number" id="ev_form_pct" value="50" oninput="sumarPorcentajes()">
                    </div>
                    <div class="form-group">
                        <label>Instrumentos</label>
                        <input id="ev_form_ins" value="Gu√≠a de observaci√≥n">
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <input id="ev_form_tipo" value="Heteroevaluaci√≥n" placeholder="Heteroevaluaci√≥n...">
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>Evaluaci√≥n Sumativa <span class="time">Final</span></h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Porcentaje (%)</label>
                        <input type="number" id="ev_sum_pct" value="40" oninput="sumarPorcentajes()">
                    </div>
                    <div class="form-group">
                        <label>Instrumentos</label>
                        <input id="ev_sum_ins" value="Cuestionario">
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <input id="ev_sum_tipo" value="Heteroevaluaci√≥n" placeholder="Heteroevaluaci√≥n...">
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>Evaluaci√≥n Satisfacci√≥n <span class="time">Final</span></h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label>Porcentaje (%)</label>
                        <input type="number" id="ev_sat_pct" value="0" oninput="sumarPorcentajes()">
                    </div>
                    <div class="form-group">
                        <label>Instrumentos</label>
                        <input id="ev_sat_ins" value="Cuestionario">
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <input id="ev_sat_tipo" value="Heteroevaluaci√≥n" placeholder="Heteroevaluaci√≥n...">
                    </div>
                </div>
            </div>
            
            <div class="box total-time-box">
                <h3 style="justify-content: flex-end;">
                    Suma Total de Porcentajes: 
                    <span id="ev_total_pct" style="color: var(--primary); font-size: 1.5rem; margin-left: 1rem;">0%</span>
                </h3>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-clock"></i>
                6. Desarrollo Cronol√≥gico / Guion Instruccional
            </h2>

            <div class="box" style="border-color: var(--warning);">
                <h3>
                    <i class="fas fa-tasks"></i> 6.1 Comprobaci√≥n de Recursos (Previo al curso)
                    <span class="time" id="precursoTime">30 min</span>
                </h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Actividades de Verificaci√≥n (basado en EC0217)</label>
                        <textarea id="dc_verificacion" rows="5" placeholder="1. Aplicar la lista de verificaci√≥n de requerimientos.&#10;2. Realizar pruebas de funcionamiento del equipo.&#10;3. Verificar la distribuci√≥n del mobiliario y equipo.&#10;4. Verificar la suficiencia de material..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tiempo estimado (minutos)</label>
                        <input type="number" id="dc_precurso_t" value="30" min="5" onchange="recalcTimes()" class="time-input" style="max-width: 150px;">
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>6.2 Apertura o Encuadre <span class="time" id="encuadreTime">22 min</span></h3>
                
                <div class="form-group">
                    <label>1. Presentaci√≥n del instructor y participantes (T√©cnica Rompehielo)</label>
                    <textarea id="enc_1_presentacion" rows="3" placeholder="El instructor se presenta, aplica t√©cnica rompehielo 'Mentira verdad', explica objetivo de la t√©cnica, controla tiempo y propicia presentaci√≥n."></textarea>
                </div>
                <div class="form-group">
                    <label>2. Presentaci√≥n del curso</label>
                    <textarea id="enc_2_curso" rows="3" placeholder="Presentar objetivos, temario, beneficios del curso y crear ambiente participativo."></textarea>
                </div>
                <div class="form-group">
                    <label>3. Momentos e instrumentos de evaluaci√≥n</label>
                    <textarea id="enc_3_evaluacion" rows="3" placeholder="Especificar tipos de evaluaci√≥n (diagn√≥stica, formativa, sumativa), instrumentos, momentos y ponderaciones."></textarea>
                </div>
                <div class="form-group">
                    <label>4. Acuerdos y compromisos</label>
                    <textarea id="enc_4_acuerdos" rows="3" placeholder="Revisar expectativas, acordar reglas de operaci√≥n (participaci√≥n, respeto, etc.), realizar Contrato de Aprendizaje."></textarea>
                </div>
                <div class="form-group">
                    <label>5. Evaluaci√≥n diagn√≥stica</label>
                    <textarea id="enc_5_diagnostico" rows="3" placeholder="Explicar alcance, dar instrucciones, indicar tiempo para contestar y aclarar dudas."></textarea>
                </div>
                <div class="form-group mt-1">
                    <label>Tiempo total del Encuadre (minutos)</label>
                    <input type="number" id="dc_encuadre_t" value="22" min="5" onchange="recalcTimes()" class="time-input" style="max-width: 150px;">
                </div>
            </div>
            
            <div class="box">
                <h3>6.3 Desarrollo de Contenidos <span class="time" id="desarrolloTime">0 min</span></h3>
                <div id="temasContainer">
                    </div>
                <button class="btn btn-primary mt-1" onclick="addTema()">
                    <i class="fas fa-plus"></i>
                    Agregar Tema/M√≥dulo
                </button>
            </div>

            <div class="box">
                <h3>6.4 Cierre <span class="time" id="cierreTime">10 min</span></h3>
                
                <div class="form-group">
                    <label>1. Conclusiones y resumen</label>
                    <textarea id="cierre_1_resumen" rows="2" placeholder="Generar conclusi√≥n de contenidos, mencionar logros."></textarea>
                </div>
                <div class="form-group">
                    <label>2. Logro de expectativas y objetivos</label>
                    <textarea id="cierre_2_logro" rows="2" placeholder="Revisar cumplimiento de expectativas y objetivos."></textarea>
                </div>
                <div class="form-group">
                    <label>3. Sugerencias de continuidad y referencias</label>
                    <textarea id="cierre_3_sugerencias" rows="2" placeholder="Sugerir acciones para continuidad, compartir bibliograf√≠a."></textarea>
                </div>
                <div class="form-group">
                    <label>4. Evaluaci√≥n de satisfacci√≥n</label>
                    <textarea id="cierre_4_satisfaccion" rows="2" placeholder="Explicar alcance, entregar instrumento y aclarar dudas."></textarea>
                </div>
                <div class="form-group">
                    <label>5. Despedida y agradecimientos</label>
                    <textarea id="cierre_5_despedida" rows="2" placeholder="Agradecer la participaci√≥n y cerrar el curso."></textarea>
                </div>
                <div class="form-group mt-1">
                    <label>Tiempo total del Cierre (minutos)</label>
                    <input type="number" id="dc_cierre_t" value="10" min="5" onchange="recalcTimes()" class="time-input" style="max-width: 150px;">
                </div>
            </div>

            <div class="box total-time-box">
                <h3>Distribuci√≥n del Tiempo Total</h3>
                <div class="grid-4">
                    <div class="form-group">
                        <label>Comprobaci√≥n</label>
                        <input id="sum_precurso" disabled>
                    </div>
                    <div class="form-group">
                        <label>Encuadre</label>
                        <input id="sum_encuadre" disabled>
                    </div>
                    <div class="form-group">
                        <label>Desarrollo</label>
                        <input id="sum_desarrollo" disabled>
                    </div>
                    <div class="form-group">
                        <label>Cierre</label>
                        <input id="sum_cierre" disabled>
                    </div>
                </div>
                <div class="form-group mt-1" style="text-align: right;">
                    <label>Total del Curso (calculado)</label>
                    <input id="sum_total" disabled style="font-weight: bold; max-width: 250px; display: inline-block;">
                    <div id="time_warning" style="display: none;"></div>
                </div>
            </div>
        </section>
    </main>

    <div class="validation-indicator invalid" id="validationIndicator" style="display: none;">
        <i class="fas fa-exclamation-circle" style="color: var(--danger);"></i>
        <span>Documento incompleto</span>
    </div>

    <script>
        // ========== CONSTANTES Y CONFIGURACI√ìN ==========
        const VERBOS = {
            cognitivo: {
                conocimiento: ['Identificar', 'Reconocer', 'Listar', 'Nombrar', 'Definir', 'Describir'],
                comprension: ['Explicar', 'Interpretar', 'Resumir', 'Clasificar', 'Comparar', 'Ejemplificar'],
                aplicacion: ['Aplicar', 'Usar', 'Implementar', 'Ejecutar', 'Resolver', 'Demostrar'],
                analisis: ['Analizar', 'Diferenciar', 'Organizar', 'Relacionar', 'Examinar', 'Contrastar'],
                evaluacion: ['Evaluar', 'Criticar', 'Justificar', 'Argumentar', 'Validar', 'Decidir'],
                creacion: ['Crear', 'Dise√±ar', 'Construir', 'Planear', 'Producir', 'Desarrollar']
            },
            psicomotriz: { 
                imitacion: ['Imitar', 'Copiar', 'Repetir', 'Reproducir', 'Seguir'],
                manipulacion: ['Manipular', 'Operar', 'Practicar', 'Ejecutar', 'Manejar'],
                precision: ['Demostrar', 'Completar', 'Mostrar', 'Calibrar', 'Controlar'],
                articulacion: ['Coordinar', 'Integrar', 'Adaptar', 'Modificar', 'Masterizar'],
                naturalizacion: ['Dise√±ar', 'Especificar', 'Gestionar', 'Inventar', 'Proyectar']
            },
            afectivo: {
                recepcion: ['Escuchar', 'Atender', 'Percibir', 'Recibir', 'Aceptar'],
                respuesta: ['Participar', 'Responder', 'Asistir', 'Practicar', 'Informar'],
                valoracion: ['Valorar', 'Apreciar', 'Justificar', 'Proponer', 'Compartir'],
                organizacion: ['Organizar', 'Integrar', 'Sintetizar', 'Priorizar', 'Combinar'],
                caracterizacion: ['Actuar', 'Discriminar', 'Influir', 'Modificar', 'Revisar']
            },
            relacional: { 
                interaccion: ['Interactuar', 'Comunicar', 'Relacionar', 'Contactar', 'Dialogar'],
                colaboracion: ['Colaborar', 'Cooperar', 'Contribuir', 'Ayudar', 'Apoyar'],
                liderazgo: ['Liderar', 'Dirigir', 'Guiar', 'Motivar', 'Inspirar'],
                negociacion: ['Negociar', 'Mediar', 'Conciliar', 'Acordar', 'Resolver'],
                facilitacion: ['Facilitar', 'Moderar', 'Coordinar', 'Dinamizar', 'Gestionar']
            }
        };
        // Variables globales
        const $ = id => document.getElementById(id);
        let objetivosCount = 0; // Se inicia en 0, se agregar√°n 4 fijos
        let temasCount = 0;

        // ========== PROTECCI√ìN DE P√ÅGINA ==========
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîç Verificando sistema...');
            
            // ===== CORRECCI√ìN: Guardia de Seguridad Robusta =====
            setTimeout(() => {
                if (typeof auth === 'undefined' || typeof EC0301Manager === 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error Cr√≠tico del Sistema',
                        html: '<p>No se pudieron cargar los m√≥dulos del sistema.</p><p>Verifica que existan:</p><ul style="text-align:left"><li>sistema_central/auth.js</li><li>sistema_central/ec0301-data-manager.js</li></ul>',
                        confirmButtonColor: '#ef4444',
                        allowOutsideClick: false
                    }).then(() => window.location.href = 'index.html');
                    return; // Detiene la ejecuci√≥n
                }

                // Verificar autenticaci√≥n
                if (!auth.isLoggedIn()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Acceso Denegado',
                        text: 'Debes iniciar sesi√≥n para acceder a este m√≥dulo.',
                        confirmButtonColor: '#6366f1',
                        allowOutsideClick: false
                    }).then(() => window.location.href = 'index.html');
                    return; // Detiene la ejecuci√≥n
                }

                console.log('‚úÖ Sistema verificado correctamente');
                initializeApp();
            }, 50); // 50ms de espera
        });

        // ========== INICIALIZACI√ìN ==========
        function initializeApp() {
            // === CAMBIO 5: Crear 4 objetivos fijos ===
            if(objetivosCount === 0) { // Solo si no se han cargado
                addObjetivoParticular('Cognitivo');
                addObjetivoParticular('Psicomotriz');
                addObjetivoParticular('Afectivo');
                addObjetivoParticular('Relacional');
            }

            loadDraft();
            
            // Si no hay temas cargados, a√±ade uno por defecto
            if (temasCount === 0) {
                addTema();
            }
            recalcTimes();
            sumarPorcentajes(); 
            updateProgress();
            
            // Auto-guardar cada 30 segundos
            setInterval(() => {
                if (updateProgress() > 5) { // Solo si hay algo que guardar
                    saveDraft(true); // true = silencioso
                }
            }, 30000);
        }
        
        // Funci√≥n de notificaci√≥n simple
        function toast(message, icon = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;
                }
            });
            Toast.fire({ icon, title: message });
        }
        // ========== FUNCIONES DE VERBOS ==========
        function renderVerbos(n, dominio) {
            const container = $(`verbs${n}`);
            if (!container) return;
            let html = '<small>üí° Verbos sugeridos (clic para usar):</small>';
            const categorias = VERBOS[dominio] || VERBOS.cognitivo;
            for (const [categoria, verbos] of Object.entries(categorias)) {
                html += `<div class="verbo-category">
                    <strong>${categoria.charAt(0).toUpperCase() + categoria.slice(1)}:</strong><br>
                    ${verbos.map(v => `<span class="verbo" onclick="insertVerbo(${n}, '${v}')">${v}</span>`).join('')}
                </div>`;
            }
            container.innerHTML = html;
        }
        function insertVerbo(n, verbo) {
            const input = $(`op${n}_accion`);
            if (!input) return;
            const textoActual = input.value.trim();
            if (!textoActual) {
                input.value = verbo + ' ';
            } else if (!textoActual.startsWith(verbo)) {
                input.value = verbo + ' ' + textoActual.replace(/^[A-Z√Å√â√ç√ì√ö√ëa-z√°√©√≠√≥√∫√±]+\s*/, '');
            }
            input.focus();
            updateProgress();
        }
        function selDom(n, dominio) {
            document.querySelectorAll(`[data-op="${n}"] .dom`).forEach(d => d.classList.remove('active'));
            document.querySelector(`[data-op="${n}"] .dom[data-d="${dominio}"]`)?.classList.add('active');
            renderVerbos(n, dominio.toLowerCase());
            updateProgress();
        }
        // ========== OBJETIVOS ==========
        function updateOG() {
            const sujeto = 'Al finalizar el curso, el participante';
            const accion = $('og_accion').value.trim();
            const condicion = $('og_cond').value.trim();
            
            let preview = sujeto;
            if (accion) preview += ' ' + accion;
            if (condicion) preview += ', ' + condicion;
            
            $('og_preview').innerHTML = preview + '.';
            updateProgress();
        }
        
        // === CAMBIO 5: Funci√≥n de Objetivo Particular modificada ===
        function addObjetivoParticular(dominioFijo = 'cognitivo') {
            objetivosCount++;
            const container = $('objetivosParticulares');
            const newObj = document.createElement('div');
            newObj.className = 'box';
            newObj.setAttribute('data-op', objetivosCount);
            
            let domsHTML = '';
            const dominios = ['Cognitivo', 'Psicomotriz', 'Afectivo', 'Relacional'];
            
            if (objetivosCount <= 4) { // Si son los 4 fijos
                dominioFijo = dominios[objetivosCount - 1];
                domsHTML = `<div class="dom active" data-op="${objetivosCount}" data-d="${dominioFijo.toLowerCase()}">${dominioFijo}</div>`;
            } else { // Si el usuario a√±ade m√°s
                domsHTML = dominios.map(d => 
                    `<div class="dom ${d.toLowerCase() === dominioFijo.toLowerCase() ? 'active' : ''}" data-op="${objetivosCount}" data-d="${d.toLowerCase()}" onclick="selDom(${objetivosCount}, '${d.toLowerCase()}')">${d}</div>`
                ).join('');
            }

            newObj.innerHTML = `
                <h3>
                    <span><i class="fas fa-tasks"></i> Objetivo Particular ${objetivosCount} (${dominioFijo})</span>
                    ${objetivosCount > 4 ? `<button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="removeObjetivo(this)"><i class="fas fa-trash"></i></button>` : ''}
                </h3>
                <div class="doms">${domsHTML}</div>
                <div class="verbos-container" id="verbs${objetivosCount}"></div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Verbo + Acci√≥n <span class="required">*</span></label>
                        <input id="op${objetivosCount}_accion" placeholder="Ej: Identificar√° los elementos clave de..." required>
                    </div>
                    <div class="form-group">
                        <label>Condici√≥n/Contexto <span class="required">*</span></label>
                        <textarea id="op${objetivosCount}_cond" placeholder="¬øEn qu√© condiciones o con qu√© recursos?" required></textarea>
                    </div>
                </div>
                <div class="form-group mt-1">
                    <label>Temas relacionados (Opcional)</label>
                    <textarea id="op${objetivosCount}_temas" placeholder="Liste los temas o m√≥dulos que apoyan este objetivo (uno por l√≠nea)"></textarea>
                </div>
                `;
            container.appendChild(newObj);
            renderVerbos(objetivosCount, dominioFijo.toLowerCase());
            newObj.style.animation = 'slideUp 0.5s ease';
            updateProgress();
            
            // Ocultar el bot√≥n de "Agregar" si ya llegamos a 4
             if(objetivosCount >= 4) {
                 $('objetivosParticulares').nextElementSibling.style.display = 'none';
             }
        }
        function removeObjetivo(button) {
            // Solo permite borrar si hay m√°s de 4 (los 4 fijos no se borran)
            const totalObjetivos = document.querySelectorAll('#objetivosParticulares .box').length;
            if (totalObjetivos <= 4) {
                Swal.fire('Error', 'Los 4 objetivos de dominio son requeridos.', 'warning');
                return;
            }
            
            Swal.fire({
                title: '¬øEliminar objetivo?', text: 'Esta acci√≥n no se puede deshacer',
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b', confirmButtonText: 'S√≠, eliminar'
            }).then((result) => {
                if (result.isConfirmed) {
                    button.closest('.box').remove();
                    Swal.fire('Eliminado', 'Objetivo eliminado.', 'success');
                    updateProgress();
                }
            });
        }
        
        // ========== TEMAS (Desarrollo) ==========
        // === CAMBIO 6: Funci√≥n addTema modificada para EC0217 (Presencial) ===
        function addTema() {
            temasCount++;
            const container = $('temasContainer');
            const tema = document.createElement('div');
            tema.className = 'box';
            tema.setAttribute('data-tema', temasCount);
            tema.innerHTML = `
                <h3>
                    <span>Tema/M√≥dulo ${temasCount}</span>
                    <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="removeTema(this)">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </h3>
                <div class="form-group">
                    <label>Nombre del Tema/M√≥dulo <span class="required">*</span></label>
                    <input id="tema${temasCount}_nombre" placeholder="T√≠tulo del tema" required>
                </div>
                <div class="form-group mt-1">
                    <label>Actividades (del instructor y participantes)</label>
                    <textarea id="tema${temasCount}_actividades" rows="4" placeholder="El instructor expone...&#10;Los participantes realizan pr√°ctica..."></textarea>
                </div>
                <div class="grid-3 mt-1">
                    <div class="form-group">
                        <label>T√©cnicas Grupales/Instruccionales</label>
                        <input id="tema${temasCount}_tecnicas" placeholder="Expositiva, Di√°logo-discusi√≥n...">
                    </div>
                    <div class="form-group">
                        <label>Material y Equipo de Apoyo</label>
                        <input id="tema${temasCount}_material" placeholder="Presentaci√≥n, Pizarr√≥n, Casos pr√°cticos...">
                    </div>
                    <div class="form-group">
                        <label>Duraci√≥n (minutos) <span class="required">*</span></label>
                        <input type="number" id="tema${temasCount}_duracion" placeholder="60" min="5" onchange="recalcTimes()" required class="time-input">
                    </div>
                </div>
            `;
            container.appendChild(tema);
            tema.style.animation = 'slideUp 0.5s ease';
            recalcTimes();
        }
        function removeTema(button) {
            Swal.fire({
                title: '¬øEliminar tema?', text: 'Esta acci√≥n no se puede deshacer',
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b', confirmButtonText: 'S√≠, eliminar'
            }).then((result) => {
                if (result.isConfirmed) {
                    button.closest('.box').remove(); 
                    recalcTimes();
                    Swal.fire('Eliminado', 'Tema eliminado.', 'success');
                }
            });
        }

        // ========== C√ÅLCULOS ==========
        // === CAMBIO 4: recalcTimes actualizado ===
        function recalcTimes() {
            const precurso = parseInt($('dc_precurso_t').value) || 0;
            $('sum_precurso').value = `${precurso} min`;
            $('precursoTime').textContent = `${precurso} min`;
            
            const encuadre = parseInt($('dc_encuadre_t').value) || 0;
            $('sum_encuadre').value = `${encuadre} min`;
            $('encuadreTime').textContent = `${encuadre} min`;
            
            const cierre = parseInt($('dc_cierre_t').value) || 0;
            $('sum_cierre').value = `${cierre} min`;
            $('cierreTime').textContent = `${cierre} min`;

            let desarrollo = 0;
            document.querySelectorAll('[data-tema] input[type="number"]').forEach(input => {
                if (input.id.includes('_duracion')) desarrollo += parseInt(input.value) || 0;
            });
            $('sum_desarrollo').value = `${desarrollo} min`;
            $('desarrolloTime').textContent = `${desarrollo} min`;

            const totalMinutos = encuadre + desarrollo + cierre; // Precurso no suma al total del curso
            const totalHoras = (totalMinutos / 60).toFixed(2);
            
            $('sum_total').value = `${totalHoras} horas (${totalMinutos} min)`;
            
            // Validar contra el encabezado
            const duracionHoras = parseFloat($('cd_duracion').value) || 0;
            const timeWarning = $('time_warning');
            
            if (duracionHoras > 0 && parseFloat(totalHoras) !== duracionHoras) {
                timeWarning.textContent = `¬°Advertencia! El tiempo total (${totalHoras}h) no coincide con la duraci√≥n del curso (${duracionHoras}h).`;
                timeWarning.style.display = 'block';
            } else {
                timeWarning.style.display = 'none';
            }

            updateProgress();
        }

        // === CAMBIO 3: Nueva funci√≥n sumarPorcentajes() ===
        function sumarPorcentajes() {
            const diag = parseInt($('ev_diag_pct').value) || 0;
            const form = parseInt($('ev_form_pct').value) || 0;
            const sum = parseInt($('ev_sum_pct').value) || 0;
            const sat = parseInt($('ev_sat_pct').value) || 0;
            const total = diag + form + sum + sat;
            
            const totalEl = $('ev_total_pct');
            totalEl.textContent = total + '%';
            if (total === 100) {
                totalEl.style.color = 'var(--success)';
            } else {
                totalEl.style.color = 'var(--danger)';
            }
            updateProgress();
        }

        // ========== PROGRESO Y VALIDACI√ìN (BUG FIX) ==========
        function updateProgress() {
            const campos = [
                'cd_nombre', 'cd_duracion', 'cd_facilitador', 'cd_dise√±ador',
                'cd_modalidad', 'cd_proposito', 'cd_perfil', 'cd_conoc', 
                'cd_hab', 'cd_num', 'cd_tipo',
                'og_accion', 'og_cond',
                'op1_accion', 'op1_cond', 'op2_accion', 'op2_cond', 'op3_accion', 'op3_cond', 'op4_accion', 'op4_cond',
                // Requerimientos actualizados
                'rq_instalaciones', 'rq_equipo', 'rq_materiales', 'rq_humanos', 'rq_seguridad',
                'ev_min', 'ev_diag_pct', 'ev_form_pct', 'ev_sum_pct', 'ev_sat_pct',
                'dc_verificacion', 'enc_1_presentacion', 'cierre_1_resumen'
            ];
            
            let completados = 0;
            campos.forEach(id => {
                if ($(id) && $(id).value.trim()) completados++;
            });
            
            // Validar que al menos un tema exista
            if ($('tema1_nombre') && $('tema1_nombre').value.trim()) completados++;
            
            const totalCampos = campos.length + 1; // +1 por el tema1
            const porcentaje = Math.round((completados / totalCampos) * 100);
            
            if ($('progressBar')) $('progressBar').style.width = porcentaje + '%';
            
            const indicator = $('validationIndicator');
            if (indicator) {
                if (porcentaje >= 95) { // Subimos el umbral
                    indicator.className = 'validation-indicator valid';
                    indicator.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success);"></i><span>Documento v√°lido (${porcentaje}%)</span>`;
                } else {
                    indicator.className = 'validation-indicator invalid';
                    indicator.innerHTML = `<i class="fas fa-exclamation-circle" style="color: var(--danger);"></i><span>${porcentaje}% completado</span>`;
                }
                indicator.style.display = 'flex';
            }
            return porcentaje;
        }

        function validateForm() {
            const porcentaje = updateProgress();
            if (porcentaje < 95) {
                Swal.fire({
                    title: 'Validaci√≥n',
                    html: `<p>El documento est√° <strong>${porcentaje}% completo</strong>.</p><p>Se requiere al menos 95% para considerarlo v√°lido.</p>`,
                    icon: 'warning',
                    confirmButtonText: 'Entendido'
                });
            } else {
                Swal.fire({
                    title: '¬°Documento v√°lido!',
                    text: 'La carta descriptiva cumple con los requisitos m√≠nimos.',
                    icon: 'success',
                    confirmButtonText: 'Excelente'
                });
            }
        }
        
        // ========== GUARDAR Y CARGAR (ACTUALIZADO) ==========
        function collectData() {
            const data = {
                // Informaci√≥n General
                nombre: $('cd_nombre').value,
                duracion: $('cd_duracion').value,
                dise√±ador: $('cd_dise√±ador').value,
                facilitador: $('cd_facilitador').value,
                lugar: $('cd_lugar').value, 
                fecha: $('cd_fecha').value, 
                modalidad: $('cd_modalidad').value,
                proposito: $('cd_proposito').value,
                // Perfil
                perfil: $('cd_perfil').value, // 'psico' renombrado a 'perfil'
                conoc: $('cd_conoc').value,
                hab: $('cd_hab').value,
                actitudes: $('cd_actitudes').value,
                num: $('cd_num').value,
                tipo: $('cd_tipo').value,
                // Obj General
                og: {
                    dom: $('og_dom').value,
                    accion: $('og_accion').value,
                    cond: $('og_cond').value,
                    criterio: $('og_criterio').value
                },
                objetivos: [],
                // Requerimientos
                rq: {
                    instalaciones: $('rq_instalaciones').value,
                    equipo: $('rq_equipo').value,
                    seguridad: $('rq_seguridad').value,
                    materiales: $('rq_materiales').value,
                    humanos: $('rq_humanos').value
                },
                // Evaluaci√≥n
                ev: {
                    min: $('ev_min').value,
                    escala: $('ev_escala').value,
                    cert: $('ev_cert').value,
                    diag_pct: $('ev_diag_pct').value, diag_ins: $('ev_diag_ins').value, diag_tipo: $('ev_diag_tipo').value,
                    form_pct: $('ev_form_pct').value, form_ins: $('ev_form_ins').value, form_tipo: $('ev_form_tipo').value,
                    sum_pct: $('ev_sum_pct').value, sum_ins: $('ev_sum_ins').value, sum_tipo: $('ev_sum_tipo').value,
                    sat_pct: $('ev_sat_pct').value, sat_ins: $('ev_sat_ins').value, sat_tipo: $('ev_sat_tipo').value
                },
                // Desarrollo
                dev: {
                    verificacion: $('dc_verificacion').value,
                    precurso_t: $('dc_precurso_t').value,
                    enc_1: $('enc_1_presentacion').value,
                    enc_2: $('enc_2_curso').value,
                    enc_3: $('enc_3_evaluacion').value,
                    enc_4: $('enc_4_acuerdos').value,
                    enc_5: $('enc_5_diagnostico').value,
                    encuadre_t: $('dc_encuadre_t').value,
                    cierre_1: $('cierre_1_resumen').value,
                    cierre_2: $('cierre_2_logro').value,
                    cierre_3: $('cierre_3_sugerencias').value,
                    cierre_4: $('cierre_4_satisfaccion').value,
                    cierre_5: $('cierre_5_despedida').value,
                    cierre_t: $('dc_cierre_t').value
                },
                temas: [],
                fechaActualizacion: new Date().toISOString()
            };
            
            document.querySelectorAll('#objetivosParticulares .box').forEach(box => {
                const n = box.dataset.op;
                if ($(`op${n}_accion`)) {
                    data.objetivos.push({
                        num: n,
                        dom: document.querySelector(`[data-op="${n}"] .dom.active`)?.dataset.d || 'cognitivo',
                        accion: $(`op${n}_accion`).value,
                        cond: $(`op${n}_cond`).value,
                        temas: $(`op${n}_temas`).value
                    });
                }
            });
            
            document.querySelectorAll('#temasContainer .box').forEach((box, index) => {
                const n = index + 1; // Re-indexar para evitar saltos si se borra
                const id = box.dataset.tema;
                if ($(`tema${id}_nombre`)) {
                    data.temas.push({
                        num: n, // Guardar como 1, 2, 3...
                        nombre: $(`tema${id}_nombre`).value,
                        duracion: $(`tema${id}_duracion`).value,
                        actividades: $(`tema${id}_actividades`).value,
                        tecnicas: $(`tema${id}_tecnicas`).value,
                        material: $(`tema${id}_material`).value
                    });
                }
            });
            return data;
        }

        function saveDraft(silent = false) {
            if (!EC0301Manager) {
                if (!silent) toast('Error: M√≥dulo de datos no cargado', 'error');
                return;
            }
            try {
                const data = collectData();
                EC0301Manager.saveData(data); // Guarda todo el objeto de la carta
                if (!silent) toast('Borrador guardado', 'success');
                updateProgress();
            } catch (e) {
                if (!silent) toast(`Error al guardar: ${e.message}`, 'error');
            }
        }
        
        function loadDraft() {
            if (!EC0301Manager) {
                toast('Error: M√≥dulo de datos no cargado', 'error');
                return;
            }
            try {
                const data = EC0301Manager.getData();
                if (!data || !data.nombre) { 
                    toast('No hay datos guardados. Empezando un nuevo documento.', 'info');
                    return;
                }
                
                // Cargar informaci√≥n general
                $('cd_nombre').value = data.nombre || '';
                $('cd_duracion').value = data.duracion || '';
                $('cd_dise√±ador').value = data.dise√±ador || '';
                $('cd_facilitador').value = data.facilitador || '';
                $('cd_lugar').value = data.lugar || '';
                $('cd_fecha').value = data.fecha || '';
                $('cd_modalidad').value = data.modalidad || 'presencial';
                $('cd_proposito').value = data.proposito || '';
                
                $('cd_perfil').value = data.perfil || data.psico || ''; // Compatibilidad
                $('cd_conoc').value = data.conoc || '';
                $('cd_hab').value = data.hab || '';
                $('cd_actitudes').value = data.actitudes || '';
                $('cd_num').value = data.num || '';
                $('cd_tipo').value = data.tipo || '';
                
                if (data.og) {
                    $('og_dom').value = data.og.dom || '';
                    $('og_accion').value = data.og.accion || '';
                    $('og_cond').value = data.og.cond || '';
                    $('og_criterio').value = data.og.criterio || 'seg√∫n lo establecido...';
                    updateOG();
                }
                
                if (data.rq) {
                    $('rq_instalaciones').value = data.rq.instalaciones || '';
                    $('rq_equipo').value = data.rq.equipo || '';
                    $('rq_seguridad').value = data.rq.seguridad || '';
                    $('rq_materiales').value = data.rq.materiales || '';
                    $('rq_humanos').value = data.rq.humanos || '';
                }
                
                if (data.ev) {
                    $('ev_min').value = data.ev.min || '80';
                    $('ev_escala').value = data.ev.escala || '0-100';
                    $('ev_cert').value = data.ev.cert || 'constancia';
                    $('ev_diag_pct').value = data.ev.diag_pct || '10';
                    $('ev_diag_ins').value = data.ev.diag_ins || 'Cuestionario';
                    $('ev_diag_tipo').value = data.ev.diag_tipo || 'Heteroevaluaci√≥n';
                    $('ev_form_pct').value = data.ev.form_pct || '50';
                    $('ev_form_ins').value = data.ev.form_ins || 'Gu√≠a de observaci√≥n';
                    $('ev_form_tipo').value = data.ev.form_tipo || 'Heteroevaluaci√≥n';
                    $('ev_sum_pct').value = data.ev.sum_pct || '40';
                    $('ev_sum_ins').value = data.ev.sum_ins || 'Cuestionario';
                    $('ev_sum_tipo').value = data.ev.sum_tipo || 'Heteroevaluaci√≥n';
                    $('ev_sat_pct').value = data.ev.sat_pct || '0';
                    $('ev_sat_ins').value = data.ev.sat_ins || 'Cuestionario';
                    $('ev_sat_tipo').value = data.ev.sat_tipo || 'Heteroevaluaci√≥n';
                }
                
                if (data.dev) {
                    $('dc_verificacion').value = data.dev.verificacion || '';
                    $('dc_precurso_t').value = data.dev.precurso_t || '30';
                    $('enc_1_presentacion').value = data.dev.enc_1 || '';
                    $('enc_2_curso').value = data.dev.enc_2 || '';
                    $('enc_3_evaluacion').value = data.dev.enc_3 || '';
                    $('enc_4_acuerdos').value = data.dev.enc_4 || '';
                    $('enc_5_diagnostico').value = data.dev.enc_5 || '';
                    $('dc_encuadre_t').value = data.dev.encuadre_t || '20';
                    $('cierre_1_resumen').value = data.dev.cierre_1 || '';
                    $('cierre_2_logro').value = data.dev.cierre_2 || '';
                    $('cierre_3_sugerencias').value = data.dev.cierre_3 || '';
                    $('cierre_4_satisfaccion').value = data.dev.cierre_4 || '';
                    $('cierre_5_despedida').value = data.dev.cierre_5 || '';
                    $('dc_cierre_t').value = data.dev.cierre_t || '10';
                }
                
                // Cargar Objetivos Particulares
                if (data.objetivos && data.objetivos.length > 0) {
                    $('objetivosParticulares').innerHTML = '';
                    objetivosCount = 0; 
                    data.objetivos.forEach(obj => {
                        addObjetivoParticular(obj.dom || dominios[objetivosCount-1]); // Llama a la funci√≥n para crear el HTML
                        
                        // Llena los datos
                        $(`op${obj.num}_accion`).value = obj.accion || '';
                        $(`op${obj.num}_cond`).value = obj.cond || '';
                        $(`op${obj.num}_temas`).value = obj.temas || '';
                    });
                }
                
                // Cargar Temas
                if (data.temas && data.temas.length > 0) {
                    $('temasContainer').innerHTML = '';
                    temasCount = 0; 
                    data.temas.forEach(tema => {
                        addTema(); // Llama a la funci√≥n para crear el HTML
                        
                        // Llena los datos
                        $(`tema${tema.num}_nombre`).value = tema.nombre || '';
                        $(`tema${tema.num}_duracion`).value = tema.duracion || '';
                        $(`tema${tema.num}_actividades`).value = tema.actividades || '';
                        $(`tema${tema.num}_tecnicas`).value = tema.tecnicas || '';
                        $(`tema${tema.num}_material`).value = tema.material || '';
                    });
                }
                
                recalcTimes();
                sumarPorcentajes();
                updateProgress();
                toast('Datos cargados correctamente', 'success');
            } catch (error) {
                console.error(error);
                toast('Error al cargar los datos. Se iniciar√° un documento vac√≠o.', 'error');
                if (temasCount === 0) addTema();
            }
        }
        // ========== EXPORTACI√ìN ==========
        function exportCarta(formato) { 
            Swal.fire('Funci√≥n en desarrollo', 'La exportaci√≥n a PDF se habilitar√° en futuras versiones.', 'info');
        }
        // ========== AYUDA ==========
        function showHelp() { 
            Swal.fire({
                title: 'Gu√≠a R√°pida - Carta Descriptiva',
                html: `<div style="text-align: left;">
                         <h4>üìù Carta Descriptiva (EC0217 / Presencial)</h4>
                         <p>Este formulario te ayuda a crear la carta descriptiva para un <strong>curso presencial</strong>, seg√∫n la estructura gen√©rica del est√°ndar EC0217.</p>
                         <h5 style="margin-top: 1rem;">‚úÖ Elementos clave:</h5>
                         <ul>
                             <li><strong>Requerimientos:</strong> Enfocados en instalaciones, equipo f√≠sico y materiales.</li>
                             <li><strong>Guion:</strong> Detalla actividades del instructor y participantes, t√©cnicas grupales y materiales de apoyo.</li>
                         </ul>
                        </div>`,
                width: 600, confirmButtonText: 'Entendido', confirmButtonColor: '#1E3A8A'
            });
        }
       // ========== COMPLETAR ==========
async function markComplete() {
    const porcentaje = updateProgress(); // ya calcula % de la carta

    if (porcentaje < 80) {
        await Swal.fire({
            title: 'Documento incompleto',
            text: `Llevas ${porcentaje}%. Necesitas al menos 80% para completar esta etapa.`,
            icon: 'warning',
            confirmButtonText: 'Entendido'
        });
        return;
    }

    const result = await Swal.fire({
        title: '¬øMarcar como completado?',
        text: 'Esto guardar√° la carta y desbloquear√° el m√≥dulo de "Log√≠stica y formatos" en tu Dashboard.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S√≠, completar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#22C55E'
    });

    if (!result.isConfirmed) return;

    // Guardado silencioso
    saveDraft(true);

    // üëâ Disparador del avance global: marcar m√≥dulo "carta"
    try {
        EC0301Manager.markModuleProgress('carta', porcentaje);
    } catch (e) {
        console.error('[Carta] Error al marcar progreso del m√≥dulo carta:', e);
    }

    await Swal.fire({
        title: '¬°Completado!',
        text: 'La carta descriptiva est√° completa. Puedes continuar con Log√≠stica y formatos.',
        icon: 'success',
        confirmButtonText: 'Ir al Dashboard',
        timer: 2000,
        timerProgressBar: true
    });

    window.location.href = 'acceso.html';
}
        }
    </script>
</body>
</html>
